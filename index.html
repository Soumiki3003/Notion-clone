<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion-lite • M1.1 Editor + Reorder</title>
  <style>
    :root{
      --bg:#ffffff; --panel:#ffffff; --panel-2:#f6f7f9; --text:#1f2328; --muted:#6b7280; --accent:#0ea5e9; --border:#e7e9ee; --shadow:0 6px 20px rgba(0,0,0,.08); --radius:12px; --gap:14px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --hover:#eef2f6; --hover2:#e7f5ff; --iconHover:#e9edf2; --blue:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 var(--font)}
    .app{--sidew:280px; display:grid; grid-template-columns: var(--sidew) 1fr; height:100vh; transition:grid-template-columns .24s ease}

    /* SIDEBAR */
    .sidebar{background:var(--panel-2); border-right:1px solid var(--border); padding:12px; display:flex; flex-direction:column; gap:10px; transition:transform .24s ease}
    /* sticky header + scrollable middle + sticky footer */
    .side-head{display:flex; flex-direction:column; gap:10px; position:sticky; top:0; background:var(--panel-2); z-index:1; padding-bottom:6px}
    .side-scroll{flex:1; overflow:auto; padding-top:6px}
    .side-foot{position:sticky; bottom:0; background:var(--panel-2)}
    .brand{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:transparent;transition:background .2s}
    .brand:hover{background:var(--hover)}
    .brand .dot{width:24px; height:24px; border-radius:6px; background:#ddd; overflow:hidden}
    .brand .name{font-weight:700; flex:1}
    .hover-controls{display:flex; align-items:center; gap:6px; opacity:0; pointer-events:none; transition:opacity .15s}
    .brand:hover .hover-controls{opacity:1; pointer-events:auto}

    .icon-pill{display:inline-flex; align-items:center; justify-content:center; width:28px; height:24px; border-radius:6px; border:0px solid var(--border); cursor:pointer}
    .icon-pill:hover{background:var(--iconHover)}

    .search{display:flex;gap:8px;align-items:center;background:transparent;border:1px solid transparent;border-radius:10px;padding:8px 10px;transition:background .15s,border-color .15s}
    .search:hover{background:var(--hover)}
    .search:focus-within{background:var(--hover);border-color:var(--border)}
    .search input{flex:1;border:0;outline:0;background:transparent}

    .side-item{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer}
    .side-item:hover{background:var(--hover)}
    .side-item.active{background:var(--hover2); border:1px solid #bde3fb}

    /* Section headers */
    .section-row{display:flex; align-items:center; gap:4px; padding:4px 6px; margin:6px 0 2px; border-radius:10px; color:#9aa1aa; cursor:pointer}
    .section-row:hover{background:var(--hover)}
    .section-title{
        font-size:12px; 
        text-transform:uppercase; 
        letter-spacing:.18em; 
        flex:0 0 auto;
         /* Keep title on left */
        }
    .chev{width:16px; 
        height:16px;
        text-align:center; 
        opacity:0; 
        pointer-events:auto; 
        transition:transform .15s; 
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        flex-shrink: 0;}
    .chev.collapsed{transform:rotate(-90deg)}
    .section-row:hover .chev{opacity: 0.7}
    .section-controls{display:flex; align-items:center; gap:6px; opacity:0; pointer-events:none; transition:opacity .12s; margin-left:auto}
    .section-row:hover .section-controls{opacity:1; pointer-events:auto}

    .ws-pages, .fav-list, .shared-list, .private-list, .apps-list, .settings-list{display:flex; flex-direction:column; gap:2px}
    
    /* Add spacing between major sections */
    .section-row{
        display:flex; 
        align-items:center; 
        gap:8px; 
        padding:4px 6px; 
        margin:6px 0 2px; 
        border-radius:10px; 
        color:#9aa1aa; 
        cursor:pointer;
        }
    .section-row:first-of-type{margin-top:6px}
    
    /* Add extra gap before Settings (after Notion apps) */
    .settings-list{margin-top:20px}
    
    /* Collapsible sections */
    .section-content.collapsed{display:none}
    
    /* FIXED: Proper node structure with expand arrow */
    .node{
      display:flex; 
      align-items:center; 
      gap:6px; 
      padding:4px 6px; 
      border-radius:6px; 
      cursor:pointer; 
      position:relative;
      font-size:14px;
      color:var(--text);
    }
    .node:hover{background:var(--hover)}
    /* Selected state - subtle background, no border */
    .node.active{background:#e8e8e8; font-weight:500}
    
    /* Node icon and label */
    .node-icon{
      display:inline-block;
      width:18px;
      text-align:center;
      flex-shrink:0;
      transition:opacity .15s;
    }
    .node:hover .node-icon{
      opacity:0;
    }
    
    /* FIXED: Expand/collapse arrow */
    .node-expand{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
      cursor:pointer;
      opacity:0;
      transition:opacity .15s, transform .15s;
      flex-shrink:0;
      color:#91918e;
      font-size:11px;
      margin-right:-18px; /* Overlay on icon position */
      z-index:1;
    }
    /* ONLY show arrow on hover (not visible by default even if has children) */
    .node:hover .node-expand{
      opacity:1;
    }
    .node-expand:hover{
      background:var(--iconHover);
    }
    .node-expand.expanded{
      transform:rotate(90deg);
    }
    
    /* FIXED: Proper nesting indentation */
    .children{
      margin-left:20px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .children.collapsed{
      display:none;
    }
    
    .drop-line{height:2px; background:var(--blue); border-radius:2px; position:absolute; left:6px; right:6px; pointer-events:none}

    .button{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; background:#fff; border:1px solid var(--border); cursor:pointer}
    /* Remove border for topbar buttons */
    .topbar .button{border:none; background:transparent}
    .topbar .button:hover{background:var(--hover)}

    .content{padding:60px 96px; overflow:auto; max-width:900px; margin:0 auto; width:100%}

    /* Private › More overlay */
    .dropdown{display:none; flex-direction:column; gap:4px; margin:4px 0 6px 8px; padding:6px; border:1px solid var(--border); background:#fff; border-radius:10px}
    .dropdown .item{padding:6px 8px; border-radius:8px; cursor:pointer}
    .dropdown .item:hover{background:var(--hover)}

    .side-sep{height:1px; background:var(--border); margin:10px 0}
    .help-row{display:flex; align-items:center; gap:8px; padding:8px 10px; color:#9aa1aa}

    /* MAIN */
    .main{display:grid; grid-template-rows:56px 1fr; min-width:0}
    .topbar{display:flex; align-items:center; gap:8px; padding:10px 24px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:5}
    .crumbs{display:flex; align-items:center; gap:6px; color:#6b7280}
    .actions{margin-left:auto; display:flex; align-items:center; gap:8px}

    .home-hero{font-size:28px; font-weight:800; text-align:center; margin:24px 0 18px}
    .home-section-title{display:flex; align-items:center; gap:8px; color:#6b7280; font-weight:600; margin:12px 0}
    .card-row{display:grid; grid-template-columns:repeat(5,1fr); gap:16px}
    .page-card{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:0; overflow:hidden}
    .page-card .thumb{height:64px; background:#f0f2f5; border-bottom:1px solid var(--border)}
    .page-card .body{padding:10px 12px}
    .page-card .title{font-weight:600}
    .page-card .meta{font-size:12px; color:#9aa1aa; margin-top:4px}
    .upcoming{background:#fff; height: 25vw; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:18px}
    .upcoming .grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; height: 22vw}
    .upcoming .panel{background:#fafafa; border:1px dashed var(--border); border-radius:15px; padding:25px; color:#9aa1aa}

    /* collapsed */
    .collapsed .app{--sidew:0px}
    .collapsed .sidebar{transform:translateX(-100%)}
    .collapsed .sidebar{
      opacity:0;
      pointer-events:none;
      visibility:hidden;
    }
    .hamburger{position:fixed; top:66px; left:10px; z-index:10; display:none}
    .collapsed .hamburger{display:inline-flex}

    @media(max-width:1200px){.card-row{grid-template-columns:repeat(3,1fr)} .upcoming .grid{grid-template-columns:1fr}}
    @media(max-width:900px){.app{--sidew:72px} .brand .name, .label-text, .fav .txt, .side-item .txt {display:none}}

    /* FIXED: node hover controls only on rightmost side */
    .node-label{ 
      flex:1; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .node-controls{ 
      display:flex; 
      align-items:center; 
      gap:4px; 
      opacity:0; 
      pointer-events:none; 
      transition:opacity .15s;
      flex-shrink:0;
    }
    /* Show controls on direct hover (+ and ... buttons as per PDF) */
    .node:hover > .node-controls{ 
      opacity:1; 
      pointer-events:auto; 
    }
    .pill{ 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      width:24px; 
      height:22px; 
      border-radius:4px; 
      border:none;
      background:transparent; 
      cursor:pointer;
      font-size:14px;
      color:#91918e;
    }
    .pill:hover{ background:#e3e2e0; }
    .chev-mini{ font-size:12px; opacity:.7 }
    .pill[data-tip]{ position:relative }
    .pill[data-tip]:hover::after{
      content:attr(data-tip); position:absolute; top:110%; left:50%; transform:translateX(-50%);
      background:#111827; color:#fff; padding:6px 8px; border-radius:6px; font-size:12px; white-space:nowrap; box-shadow:0 6px 20px rgba(0,0,0,.2);
      z-index:1000;
    }
    .ctx{ position:absolute; z-index:9999; min-width:240px; max-width:320px; background:#111; color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px; box-shadow:0 20px 60px rgba(0,0,0,.35); }
    .ctx .grp{ padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.08); margin-bottom:6px; }
    .ctx .item{ padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px; }
    .ctx .item:hover{ background:rgba(255,255,255,.08); }
    .ctx .muted{ color:#9aa1aa; font-size:12px; margin-top:6px; }

    /* icon tray */
    .icon-tray{position:fixed; z-index:10000; left:50%; top:18%; transform:translateX(-50%); width:520px; max-width:95vw; background:#1f1f1f; color:#fff; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:14px}
    .icon-tray .tabs{display:flex; gap:8px; margin-bottom:8px}
    .icon-tray .tab{padding:6px 10px; border-radius:8px; background:#2a2a2a; cursor:pointer}
    .icon-tray .tab.active{background:#3a3a3a}
    .icon-grid{display:grid; grid-template-columns:repeat(10,1fr); gap:6px; max-height:260px; overflow:auto}
    .icon-grid div{font-size:22px; text-align:center; padding:6px; border-radius:8px; cursor:pointer}
    .icon-grid div:hover{background:#333}
    .icon-tray .footer{display:flex; justify-content:flex-end; gap:8px; margin-top:8px}
    .hidden{display:none}
    .cover{height:180px; border:1px solid var(--border); border-radius:10px; margin:10px 0; background-size:cover; background-position:center; position:relative}
    .icon-over{position:absolute; left:16px; bottom:-22px; width:44px; height:44px; border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; font-size:22px; box-shadow:var(--shadow); border:1px solid var(--border)}
    .editor-placeholder{color:#9aa1aa}

    /* Notion-like quick-actions (hover only over that specific area) */
    .quick-actions{
      display:flex; align-items:center; gap:22px;
      margin:8px 0; color:#9aa1aa; font-weight:400; font-size:14px;
      margin-top: 20px;
      opacity:0; transition:opacity .15s;
      padding:12px 0;
      pointer-events:auto; /* Allow hover detection */
    }
    /* Show when hovering over the area */
    .quick-actions:hover{ opacity:1; }
    .quick-actions .qa{ 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      cursor:pointer;
      padding:4px 8px;
      border-radius:6px;
      transition:background .15s;
      margin-top: 10px;
    }
    .quick-actions .qa .ico{ font-size:18px; line-height:1; opacity:.95; }
    .quick-actions .qa:hover{ 
      color:#6b7280; 
      background:var(--hover);
    }

    /* Private overlay next to sidebar */
    .priv-panel{position:fixed; top:0; left:var(--sidew); height:100vh; width:420px; max-width:95vw; background:#111; color:#fff; border-right:1px solid rgba(255,255,255,.08); z-index:9998; padding:12px 12px 8px 12px; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,.35)}
    
    .pill-btn{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; background:#1b1b1b; border:1px solid #222; cursor:pointer; margin-right:6px; margin-bottom:6px}

    /* --- Nesting + drop guide --- */
    .node.drop-before { box-shadow: inset 0 -2px 0 #1d9bf0; }
    /* --- Private overlay docked --- */
    .priv-dock {
      position:fixed; 
      top:0; 
      bottom:0; 
      left:var(--sidew);
      width:420px; 
      background:#fff; 
      color:var(--text); 
      z-index:9998;
      border-right:1px solid var(--border);
      display:flex; 
      flex-direction:column; 
      padding:16px;
      box-shadow: 12px 0 40px rgba(0,0,0,.12);
      transform:translateX(-100%);
      transition:transform .3s ease;
    }
    .priv-dock.opening{
      animation:slideIn .3s ease forwards;
    }
    @keyframes slideIn {
      from {
        transform:translateX(-100%);
      }
      to {
        transform:translateX(0);
      }
    }
    .priv-backdrop{
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,.15); 
      z-index:9997;
      opacity:0;
      transition:opacity .3s ease;
    }
    .priv-backdrop.visible{
      opacity:1;
    }
    
    /* Private overlay styles */
    .priv-dock .header{
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }
    .priv-dock .header .title{
      font-weight:600;
      font-size:16px;
    }
    .priv-dock .close-btn{
      width:28px;
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      cursor:pointer;
      transition:background .15s;
      opacity:0.6;
    }
    .priv-dock .close-btn:hover{
      background:var(--hover);
      opacity:1;
    }
    .priv-dock .search-input{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--panel-2);
      margin-bottom:16px;
      outline:none;
      font-size:14px;
    }
    .priv-dock .search-input:focus{
      border-color:#91918e;
    }
    .priv-dock .pages-section{
      flex:1;
      overflow:auto;
      margin-bottom:16px;
    }
    .priv-dock .page-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
      transition:background .15s;
      position:relative;
    }
    .priv-dock .page-item:hover{
      background:var(--hover);
    }
    .priv-dock .page-item .expand-chev{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transition:opacity .15s;
      font-size:12px;
      color:#91918e;
    }
    .priv-dock .page-item:hover .expand-chev{
      opacity:1;
    }
    .priv-dock .page-item .page-icon{
      font-size:16px;
      line-height:1;
    }
    .priv-dock .page-item .page-title{
      flex:1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .priv-dock .page-item .page-controls{
      display:flex;
      align-items:center;
      gap:4px;
      opacity:0;
      transition:opacity .15s;
    }
    .priv-dock .page-item:hover .page-controls{
      opacity:1;
    }
    .priv-dock .page-item .ctrl-btn{
      width:24px;
      height:24px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
      cursor:pointer;
      transition:background .15s;
      font-size:14px;
      color:#91918e;
    }
    .priv-dock .page-item .ctrl-btn:hover{
      background:#e3e2e0;
    }
    .priv-dock .page-nested{
      font-size:13px;
      color:#9aa1aa;
    }

    /* --- Cover + icon + comment placement (Notion-like) --- */
    .cover-wrap{ 
      position:relative; 
      margin:-100px -100px -100px -100px; /* Extend to edges including top, compensating for content padding */
      margin-bottom:10px;
    }
    .cover-wrap .cover{ 
      height:400px; 
      border-radius:0; /* No rounded corners for full-width */
      background-size:cover;
      background-position:center;
    }
    .page-emoji{
      position:absolute; left:114px; bottom:-22px; /* 96px padding + 18px offset */
      font-size:78px; line-height:1;
      background:transparent; box-shadow:none; border:none;
      width:auto; height:auto; border-radius:0; padding:0;
      cursor:pointer;
    }
    .comment-chip{
      position:absolute; left:114px; top:16px; /* 96px padding + 18px offset */
      background:rgba(255,255,255,0.9); color:#6b7280;
      border:1px solid var(--border); border-radius:8px; padding:6px 10px;
      display:flex; align-items:center; gap:8px; font-weight:600;
      box-shadow:var(--shadow); cursor:pointer;
      opacity:0; transition:opacity .15s;
    }
    .cover-wrap:hover .comment-chip{ opacity:1; }
    .comment-chip:hover{ background:#fff }

    .task-ctx{
      position:absolute;
      z-index:9999;
      min-width:280px;
      max-width:320px;
      background:#1f1f1f;
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:8px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .task-ctx .search-box{
      margin-bottom:8px;
    }
    .task-ctx .search-box input{
      width:100%;
      padding:8px 12px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.2);
      background:#2a2a2a;
      color:#fff;
      outline:none;
      font-size:14px;
    }
    .task-ctx .search-box input:focus{
      border-color:rgba(59,130,246,.5);
    }
    .task-ctx .section{
      margin-top:8px;
    }
    .task-ctx .section-title{
      font-size:12px;
      color:#9aa1aa;
      padding:6px 12px;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .task-ctx .ctx-item{
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      transition:background .15s;
    }
    .task-ctx .ctx-item:hover{
      background:rgba(255,255,255,.08);
    }
    .task-ctx .ctx-item .icon{
      font-size:16px;
      width:20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .task-ctx .ctx-item .label{
      flex:1;
    }
    .task-ctx .ctx-item .shortcut{
      font-size:12px;
      color:#9aa1aa;
    }
    .task-ctx .ctx-item .chevron{
      font-size:12px;
      color:#9aa1aa;
    }
    .task-ctx .divider{
      height:1px;
      background:rgba(255,255,255,.08);
      margin:6px 0;
    }
    .task-ctx .footer{
      font-size:12px;
      color:#9aa1aa;
      padding:8px 12px;
      margin-top:6px;
    }

    /* If no cover, show icon inline with title like before */
    .title-row{ display:flex; align-items:center; gap:10px; margin-top:5px; }
    .title-emoji{ font-size:28px; line-height:1; cursor:pointer; }

    /* --- Nested page links with hover preview --- */
    .page-link{
      display:flex;
      justify-content: flex-start;
      align-items:center;
      gap:8px;
      padding:4px 8px;
      margin:0 4px 4px 0;
      border-radius:6px;
      cursor:pointer;
      position:relative;
      transition:background .15s;
    }
    .page-link:hover{
      background:#f5f5f5;
    }
    .page-link-icon{
      font-size:16px;
      line-height:1;
      opacity:0;
      transition:opacity .15s;
    }
    .page-link:hover .page-link-icon{
      opacity:1;
    }
    .page-link-drag{
      cursor:grab;
      opacity:0.5;
      margin-left:-4px;
    }
    .page-link:hover .page-link-drag{
      opacity:1;
    }
    .page-link-text{
      width: 100vw;
      color:var(--text);
      text-decoration:underline;
      text-decoration-color:#d1d5db;
    }
    .page-link-text .doc-icon{
      margin-right:6px;
      opacity:0.7;
    }

    /* Tooltip styles for nested page icons */
    .page-link-icon[data-tooltip]{
      position:relative;
    }
    .page-link-icon[data-tooltip]:hover::after{
      content:attr(data-tooltip);
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translateX(-50%);
      margin-bottom:8px;
      background:#1f1f1f;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
      white-space:nowrap;
      z-index:1000;
      pointer-events:none;
    }
    .page-link-icon:hover{
      background:rgba(0,0,0,0.06);
      border-radius:4px;
    }
    
    
    /* Page preview overlay */
    .page-preview{
      position:fixed;
      width:350px;
      max-width:90vw;
      max-height:400px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      padding:24px;
      z-index:10001;
      overflow:auto;
      pointer-events:none;
    }
    .page-preview-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.3);
      z-index:10000;
      pointer-events:none;
    }
    .page-preview-icon{
      font-size:40px;
      margin-bottom:12px;
    }
    .page-preview-breadcrumbs{
      font-size:12px;
      color:#9aa1aa;
      margin-bottom:8px;
    }
    .page-preview-title{
      font-size:24px;
      font-weight:700;
      margin-bottom:16px;
    }
    .page-preview-content{
      color:#6b7280;
      line-height:1.6;
    }

    /* --- Task List board (minimal) --- */
    .board{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:14px }
    .col{ background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden }
    .col .head{ font-weight:700; padding:8px 10px }
    .col.red .head{ color:#c2410c; background:#fef2f2 }
    .col.amber .head{ color:#92400e; background:#fff7ed }
    .col.green .head{ color:#166534; background:#ecfdf5 }
    .col .body{ padding:8px 10px; color:#9aa1aa }
    .col .new{ margin:8px 10px; border:1px dashed var(--border); border-radius:10px; padding:8px; cursor:pointer; text-align:center }
    .col .new:hover{ background:#fafafa }

    /* Task List Specific Styles */
    .task-page-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .task-page-header .task-icon{
      font-size:48px;
      line-height:1;
    }
    .task-page-header .task-title{
      font-size:40px;
      font-weight:800;
      border:none;
      outline:none;
      background:transparent;
      flex:1;
    }
    .task-description{
      color:#6b7280;
      margin-bottom:24px;
      line-height:1.6;
    }
    .task-board-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .task-board-controls{
      display:flex;
      align-items:center;
      gap:1px;
    }
    .task-board-controls .control-btn{
      padding:8px 12px;
      border-radius:8px;
      border:0px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      transition:background .15s;
      position:relative;
    }
    .task-board-controls .control-btn:hover{
      background:var(--hover);
    }
    .task-board-controls .control-btn::after{
      content:attr(data-label);
      position:absolute;
      bottom:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%);
      background:#1f1f1f;
      color:#fff;
      padding:6px 12px;
      border-radius:6px;
      font-size:13px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s;
      z-index:1000;
    }
    .task-board-controls .control-btn:hover::after{
      opacity:1;
    }
    .task-board-controls .new-btn{
      background:var(--blue);
      color:#fff;
      border:none;
      padding:8px 16px;
      font-weight:600;
    }
    .task-board-controls .new-btn:hover{
      background:#2563eb;
    }
    .board-view-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      border-radius:10px;
      background:#fff;
      border:1px solid var(--border);
      cursor:pointer;
      font-weight:600;
      margin-bottom:16px;
      transition:background .15s;
    }
    .board-view-btn:hover{
      background:var(--hover);
    }
    
    /* Updated board styles */
    .board{ 
      display:flex;
      gap:16px; 
      margin-top:14px;
      overflow-x:auto;
      padding-bottom:16px;
    }
    .col{ 
      background:#fafafa; 
      border:1px solid var(--border); 
      border-radius:12px; 
      overflow:visible;
      min-height:200px;
      padding:12px;
      width:280px;
      flex-shrink:0;
    }
    .col .head{ 
      font-weight:600; 
      padding:6px 10px;
      border-radius:6px;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:12px;
      font-size:14px;
    }
    .col.red .head{ 
      color:#991b1b; 
      background:#fee2e2;
    }
    .col.amber .head{ 
      color:#92400e; 
      background:#fef3c7;
    }
    .col.green .head{ 
      color:#065f46; 
      background:#d1fae5;
    }
    .col .head .count{
      opacity:0.7;
      font-weight:400;
    }
    .col .head .controls{
      margin-left:auto;
      display:flex;
      gap:4px;
      opacity:0;
      transition:opacity .15s;
    }
    .col .head:hover .controls{
      opacity:1;
    }
    .col .head .controls button{
      width:24px;
      height:24px;
      border-radius:4px;
      border:none;
      background:transparent;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:background .15s;
    }
    .col .head .controls button:hover{
      background:rgba(0,0,0,0.1);
    }
    .col .body{ 
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .col .task-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px 12px;
      cursor:pointer;
      transition:background .15s, box-shadow .15s, border-color .15s;
      display:flex;
      align-items:center;
      gap:8px;
      position:relative;
    }
    .col .task-card:hover{
      background:#f5f5f5;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }
    .col .task-card-content{
      flex:1;
      min-width:0;
    }
    .col .task-card input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:14px;
      font-family:inherit;
    }
    .col .task-card-controls{
      display:flex;
      align-items:center;
      gap:4px;
      opacity:0;
      transition:opacity .15s;
    }
    .col .task-card:hover .task-card-controls{
      opacity:1;
    }
    .col .task-card-controls button{
      width:28px;
      height:28px;
      border-radius:4px;
      border:none;
      background:transparent;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      color:#6b7280;
      transition:background .15s;
    }
    .col .task-card-controls button:hover{
      background:#e5e5e5;
    }
    .col .new{ 
      margin:0;
      border:1px dashed var(--border); 
      border-radius:8px; 
      padding:10px 12px; 
      cursor:pointer; 
      text-align:left;
      background:transparent;
      color:#6b7280;
      display:flex;
      align-items:center;
      gap:8px;
      transition:background .15s;
    }
    .col .new:hover{ 
      background:#fafafa;
    }
    .new-group-col{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:200px;
      width:240px;
      flex-shrink:0;
      border:2px dashed var(--border);
      border-radius:12px;
      cursor:pointer;
      color:#9aa1aa;
      font-weight:600;
      transition:background .15s, border-color .15s;
    }
    .new-group-col:hover{
      background:#fafafa;
      border-color:#91918e;
    }
    
    /* Task detail sidebar */
    .task-detail-sidebar{
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:50vw;
      max-width:800px;
      min-width:600px;
      background:#fff;
      border-left:1px solid var(--border);
      box-shadow:-12px 0 40px rgba(0,0,0,0.12);
      z-index:9999;
      transform:translateX(100%);
      transition:transform .3s ease;
      display:flex;
      flex-direction:column;
    }
    @media(max-width:1200px){
      .task-detail-sidebar{
        width:60vw;
        min-width:500px;
      }
    }
    @media(max-width:768px){
      .task-detail-sidebar{
        width:90vw;
        min-width:0;
      }
    }
    .task-detail-sidebar.open{
      transform:translateX(0);
    }
    .task-detail-header{
      padding:16px 24px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .task-detail-header .close-btn{
      width:32px;
      height:32px;
      border-radius:6px;
      border:none;
      background:transparent;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:background .15s;
    }
    .task-detail-header .close-btn:hover{
      background:var(--hover);
    }
    .task-detail-body{
      flex:1;
      overflow:auto;
      padding:24px;
    }
    .task-detail-title{
      font-size:32px;
      font-weight:800;
      border:none;
      outline:none;
      background:transparent;
      width:100%;
      margin-bottom:24px;
    }
    .task-property{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 0;
      border-bottom:1px solid var(--border);
    }
    .task-property-label{
      color:#6b7280;
      font-size:13px;
      min-width:120px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .task-property-value{
      flex:1;
    }
    .task-status-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
    }
    .task-status-badge.todo{
      background:#fee2e2;
      color:#991b1b;
    }
    .task-status-badge.doing{
      background:#fef3c7;
      color:#92400e;
    }
    .task-status-badge.done{
      background:#d1fae5;
      color:#065f46;
    }
    .add-property-btn{
      color:#9aa1aa;
      padding:8px 0;
      cursor:pointer;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:6px;
      transition:color .15s;
    }
    .add-property-btn:hover{
      color:var(--text);
    }
    .task-comments-section{
      margin-top:24px;
      padding-top:24px;
      border-top:1px solid var(--border);
    }
    .task-comments-section h4{
      margin-bottom:12px;
      font-size:14px;
      font-weight:600;
    }
    .task-detail-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.3);
      z-index:9998;
      opacity:0;
      transition:opacity .3s ease;
    }
    .task-detail-backdrop.visible{
      opacity:1;
    }

    /* Get started with section */
    .get-started-section{
      position:fixed;
      bottom:60px;
      left:calc(var(--sidew) + (100vw - var(--sidew)) / 2);
      transform:translateX(-50%);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:16px;
      z-index:100;
      transition:left .24s ease;
    }
    .get-started-label{
      color:#9b9a97;
      font-size:14px;
      font-weight:500;
      padding-left:4px;
    }
    .get-started-buttons{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .get-started-btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 20px;
      border-radius:25px;
      border:none;
      background:#f7f6f3;
      cursor:pointer;
      font-size:15px;
      font-weight:500;
      transition:background .15s;
      box-shadow:none;
    }
    .get-started-btn:hover{
      background:#efedea;
    }
    .get-started-btn .icon{
      font-size:20px;
    }
    .get-started-btn.more-btn{
      padding:10px 20px;
    }

    /* View type selector overlay */
    .view-type-overlay{
      position:fixed;
      background:#fff;
      border:1px solid #e3e2e0;
      border-radius:12px;
      box-shadow:0 16px 70px rgba(0,0,0,0.2);
      padding:6px;
      width:240px;
      z-index:10001;
    }
    .view-type-overlay .view-option{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      transition:background .15s;
    }
    .view-type-overlay .view-option:hover{
      background:#f7f6f3;
    }
    .view-type-overlay .view-option .icon{
      font-size:18px;
      width:24px;
      text-align:center;
    }
    .view-type-overlay .view-option .label{
      flex:1;
      font-size:14px;
      font-weight:400;
    }
    .view-type-overlay .divider{
      height:1px;
      background:#e3e2e0;
      margin:4px 0;
    }
    .view-type-backdrop{
      position:fixed;
      inset:0;
      z-index:10000;
      background:transparent;
    }

    /* List view styles */
    .list-view-container{
      margin-top:20px;
    }
    .list-view-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .list-view-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 14px;
      border-radius:8px;
      background:#fff;
      border:1px solid var(--border);
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:background .15s;
    }
    .list-view-btn:hover{
      background:var(--hover);
    }
    .list-view-btn .icon{
      font-size:16px;
    }
    .list-view-controls{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .list-view-controls .control-btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      transition:background .15s;
      position:relative;
    }
    .list-view-controls .control-btn:hover{
      background:var(--hover);
    }
    .list-view-controls .control-btn::after{
      content:attr(data-label);
      position:absolute;
      bottom:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%);
      background:#1f1f1f;
      color:#fff;
      padding:6px 12px;
      border-radius:6px;
      font-size:13px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s;
      z-index:1000;
    }
    .list-view-controls .control-btn:hover::after{
      opacity:1;
    }
    .list-view-controls .new-btn{
      background:var(--blue);
      color:#fff;
      border:none;
      padding:8px 16px;
      font-weight:600;
    }
    .list-view-controls .new-btn:hover{
      background:#2563eb;
    }
    .list-entries{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .list-entry{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
      cursor:pointer;
      transition:background .15s, box-shadow .15s;
    }
    .list-entry:hover{
      background:#fafafa;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    .list-entry .icon{
      font-size:18px;
    }
    .list-entry .title{
      flex:1;
      font-size:14px;
      color:var(--text);
    }
    .list-entry .title input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:14px;
      font-family:inherit;
    }
    .new-entry-btn{
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 16px;
      color:#9aa1aa;
      cursor:pointer;
      border-radius:8px;
      transition:background .15s;
    }
    .new-entry-btn:hover{
      background:#fafafa;
    }

    /* Database entry detail sidebar */
    .db-entry-sidebar{
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:50vw;
      max-width:800px;
      min-width:600px;
      background:#fff;
      border-left:1px solid var(--border);
      box-shadow:-12px 0 40px rgba(0,0,0,0.12);
      z-index:9999;
      transform:translateX(100%);
      transition:transform .3s ease;
      display:flex;
      flex-direction:column;
    }
    @media(max-width:1200px){
      .db-entry-sidebar{
        width:60vw;
        min-width:500px;
      }
    }
    @media(max-width:768px){
      .db-entry-sidebar{
        width:90vw;
        min-width:0;
      }
    }
    .db-entry-sidebar.open{
      transform:translateX(0);
    }
    .db-entry-header{
      padding:16px 24px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .db-entry-header .close-btn{
      width:32px;
      height:32px;
      border-radius:6px;
      border:none;
      background:transparent;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:background .15s;
      font-size:18px;
    }
    .db-entry-header .close-btn:hover{
      background:var(--hover);
    }
    .db-entry-body{
      flex:1;
      overflow:auto;
      padding:24px;
    }
    .db-entry-title{
      font-size:32px;
      font-weight:800;
      border:none;
      outline:none;
      background:transparent;
      width:100%;
      margin-bottom:24px;
      color:var(--text);
    }
    .db-entry-title::placeholder{
      color:#d1d5db;
    }
    .db-property{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 0;
      border-bottom:1px solid var(--border);
    }
    .db-property-label{
      color:#6b7280;
      font-size:13px;
      min-width:120px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .db-property-value{
      flex:1;
      color:#9aa1aa;
    }
    .add-property-btn{
      color:#9aa1aa;
      padding:8px 0;
      cursor:pointer;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:6px;
      transition:color .15s;
    }
    .add-property-btn:hover{
      color:var(--text);
    }
    .db-comments-section{
      margin-top:24px;
      margin-bottom:24px;
    }
    .db-comments-section h4{
      margin-bottom:12px;
      font-size:14px;
      font-weight:600;
    }
    .db-entry-content{
      padding:16px 0;
      border-top:1px solid var(--border);
      color:#9aa1aa;
      font-size:14px;
    }
    .db-entry-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.3);
      z-index:9998;
      opacity:0;
      transition:opacity .3s ease;
    }
    .db-entry-backdrop.visible{
      opacity:1;
    }

    /* Tag system styles */
    .tag-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:background .15s, opacity .15s;
    }
    .tag-pill:hover{
      filter:brightness(0.92);
    }
    .tag-pill .remove{
      font-size:14px;
      opacity:0.6;
      cursor:pointer;
      transition:opacity .15s;
    }
    .tag-pill .remove:hover{
      opacity:1;
    }

    /* Tag colors */
    .tag-default{ background:#e5e7eb; color:#374151; }
    .tag-gray{ background:#e5e7eb; color:#374151; }
    .tag-brown{ background:#e0d4c8; color:#6b5744; }
    .tag-orange{ background:#fed7aa; color:#c2410c; }
    .tag-yellow{ background:#fef3c7; color:#a16207; }
    .tag-green{ background:#d1fae5; color:#065f46; }
    .tag-blue{ background:#dbeafe; color:#1e40af; }
    .tag-purple{ background:#e9d5ff; color:#6b21a8; }
    .tag-pink{ background:#fce7f3; color:#9f1239; }
    .tag-red{ background:#fee2e2; color:#991b1b; }

    /* Tag dropdown */
    .tag-dropdown{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:4px;
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:12px;
      box-shadow:0 12px 40px rgba(0,0,0,0.15);
      padding:8px;
      z-index:1000;
      max-height:400px;
      overflow-y:auto;
    }
    .tag-dropdown-header{
      color:#9aa1aa;
      font-size:13px;
      padding:8px 12px;
      border-bottom:1px solid #e0e0e0;
      margin-bottom:4px;
    }
    .tag-dropdown-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
      position:relative;
    }
    .tag-dropdown-item:hover{
      background:#f7f6f3;
    }
    .tag-dropdown-item .drag-handle{
      font-size:14px;
      color:#9aa1aa;
      cursor:grab;
      opacity:0;
      transition:opacity .15s;
    }
    .tag-dropdown-item:hover .drag-handle{
      opacity:1;
    }
    .tag-dropdown-item .tag-label{
      flex:1;
      padding:4px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
    }
    .tag-dropdown-item .more-btn{
      font-size:16px;
      color:#9aa1aa;
      cursor:pointer;
      padding:4px 8px;
      border-radius:6px;
      opacity:0;
      transition:opacity .15s, background .15s;
    }
    .tag-dropdown-item:hover .more-btn{
      opacity:1;
    }
    .tag-dropdown-item .more-btn:hover{
      background:#e0e0e0;
    }
    .tag-create-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
      background:#f7f6f3;
    }
    .tag-create-item:hover{
      background:#efedea;
    }

    /* Tag options menu */
    .tag-options-menu{
      position:fixed;
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.2);
      padding:12px;
      width:320px;
      z-index:10000;
    }
    .tag-rename-input{
      width:100%;
      padding:10px 14px;
      border:2px solid var(--blue);
      border-radius:8px;
      font-size:14px;
      outline:none;
      margin-bottom:12px;
    }
    .tag-menu-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
      font-size:14px;
    }
    .tag-menu-item:hover{
      background:#f7f6f3;
    }
    .tag-menu-divider{
      height:1px;
      background:#e0e0e0;
      margin:8px 0;
    }
    .tag-color-option{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
    }
    .tag-color-option:hover{
      background:#f7f6f3;
    }
    .tag-color-swatch{
      width:24px;
      height:24px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.1);
    }
    .tag-color-option .checkmark{
      margin-left:auto;
      font-size:18px;
      color:var(--text);
    }
    .tag-input-wrapper{
      position:relative;
    }

    /* Sort dropdown */
    .sort-dropdown{
      position:fixed;
      background:#1f1f1f;
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.3);
      padding:12px;
      width:280px;
      z-index:10001;
    }
    .sort-search{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.2);
      background:#2a2a2a;
      color:#fff;
      outline:none;
      font-size:14px;
      margin-bottom:12px;
    }
    .sort-search:focus{
      border-color:rgba(59,130,246,.5);
    }
    .sort-option{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
    }
    .sort-option:hover{
      background:rgba(255,255,255,.08);
    }
    .sort-option .icon{
      font-size:18px;
      width:24px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sort-option .label{
      flex:1;
      font-size:14px;
    }
    .sort-option.active{
      background:rgba(59,130,246,.2);
    }
    .sort-dropdown-backdrop{
      position:fixed;
      inset:0;
      z-index:10000;
      background:transparent;
    }

      /* Active sort state */
    .control-btn.sort-active{
      background:#e5e5e5 !important;
    }

    /* Sort chip below list view */
    .sort-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:20px;
      border:2px solid #2383e2;
      background:transparent;
      color:#2383e2;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:background .15s;
      
    }
    .sort-chip:hover{
      background:rgba(35,131,226,0.1);
    }
    .sort-chip .arrow{
      font-size:12px;
    }
    .sort-chip .close{
      font-size:16px;
      opacity:0.7;
      margin-left:4px;
    }
    .sort-chip .close:hover{
      opacity:1;
    }

    /* Sort management dropdown */
    .sort-manage-dropdown{
      position:fixed;
      background:#1f1f1f;
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.3);
      padding:12px;
      width:320px;
      z-index:10001;
    }
    .sort-manage-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
      margin-bottom:8px;
    }
    .sort-manage-header .drag-icon{
      font-size:16px;
      color:#9aa1aa;
      cursor:grab;
    }
    .sort-field-select,
    .sort-direction-select{
      flex:1;
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.2);
      background:#2a2a2a;
      color:#fff;
      outline:none;
      font-size:14px;
      cursor:pointer;
    }
    .sort-field-select:hover,
    .sort-direction-select:hover{
      background:#333;
    }
    .sort-manage-header .close-icon{
      font-size:18px;
      cursor:pointer;
      opacity:0.7;
      padding:4px;
    }
    .sort-manage-header .close-icon:hover{
      opacity:1;
    }
    .sort-manage-actions{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:8px;
    }
    .sort-manage-action{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
    }
    .sort-manage-action:hover{
      background:rgba(255,255,255,.08);
    }
    .sort-manage-action .icon{
      font-size:16px;
      width:20px;
    }

    /* Filter chip */
    .filter-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:20px;
      border:1px solid #e0e0e0;
      background:#fff;
      color:var(--text);
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:background .15s, border-color .15s;
      margin-right:8px;
    }
    .filter-chip:hover{
      background:#f5f5f5;
      border-color:#d0d0d0;
    }
    .filter-chip .icon{
      font-size:16px;
    }

    /* Filter dropdown */
    .filter-dropdown{
      position:fixed;
      background:#1f1f1f;
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.3);
      padding:12px;
      width:280px;
      z-index:10001;
    }
    .filter-search{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.2);
      background:#2a2a2a;
      color:#fff;
      outline:none;
      font-size:14px;
      margin-bottom:12px;
    }
    .filter-search:focus{
      border-color:rgba(59,130,246,.5);
    }
    .filter-option{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
    }
    .filter-option:hover{
      background:rgba(255,255,255,.08);
    }
    .filter-option .icon{
      font-size:18px;
      width:24px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .filter-option .label{
      flex:1;
      font-size:14px;
    }
    .filter-divider{
      height:1px;
      background:rgba(255,255,255,.08);
      margin:8px 0;
    }
    .filter-advanced{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
      margin-top:4px;
    }
    .filter-advanced:hover{
      background:rgba(255,255,255,.08);
    }
    .filter-advanced .icon{
      font-size:16px;
    }

    /* Separator line */
    .list-view-separator{
      height:1px;
      background:#e7e9ee;
      margin:16px 0;
      width:100%;
    }

    /* Property type selector */
    .property-type-selector{
      position:fixed;
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.2);
      padding:8px;
      width:320px;
      z-index:10001;
      max-height:600px;
      overflow-y:auto;
    }
    .property-name-input{
      width:100%;
      padding:12px 14px;
      border:2px solid #3b82f6;
      border-radius:8px;
      outline:none;
      font-size:14px;
      margin-bottom:12px;
    }
    .property-type-label{
      color:#6b7280;
      font-size:13px;
      padding:8px 12px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .property-type-option{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
    }
    .property-type-option:hover{
      background:#f7f6f3;
    }
    .property-type-option .icon{
      font-size:16px;
      width:24px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .property-type-option .label{
      flex:1;
      font-size:14px;
    }

    /* Property configuration panel */
    .property-config-panel{
      position:fixed;
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.2);
      padding:12px;
      width:340px;
      z-index:10002;
      max-height:500px;
      overflow-y:auto;
    }
    .property-config-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
      margin-bottom:12px;
      border-bottom:1px solid #e0e0e0;
    }
    .property-config-icon{
      font-size:20px;
    }
    .property-config-name{
      flex:1;
      padding:8px 12px;
      border:2px solid #3b82f6;
      border-radius:8px;
      outline:none;
      font-size:14px;
    }
    .property-config-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
      justify-content:space-between;
    }
    .property-config-item:hover{
      background:#f7f6f3;
    }
    .property-config-item .label{
      flex:1;
      font-size:14px;
      color:var(--text);
    }
    .property-config-item .value{
      color:#9aa1aa;
      font-size:14px;
    }
    .property-config-item .chevron{
      font-size:14px;
      color:#9aa1aa;
    }
    .property-config-divider{
      height:1px;
      background:#e0e0e0;
      margin:8px 0;
    }
    .property-config-section{
      padding:8px 0;
    }
    .property-config-section-title{
      color:#6b7280;
      font-size:13px;
      padding:8px 12px;
      font-weight:600;
    }
    .property-option-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
    }
    .property-option-item:hover{
      background:#f7f6f3;
    }
    .property-option-item .drag-handle{
      font-size:14px;
      color:#9aa1aa;
      cursor:grab;
      opacity:0;
      transition:opacity .15s;
    }
    .property-option-item:hover .drag-handle{
      opacity:1;
    }
    .property-option-item .option-label{
      flex:1;
      padding:4px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
    }
    .property-option-item .chevron{
      font-size:14px;
      color:#9aa1aa;
      opacity:0;
      transition:opacity .15s;
    }
    .property-option-item:hover .chevron{
      opacity:1;
    }
    .property-add-option{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      transition:background .15s;
      color:#6b7280;
    }
    .property-add-option:hover{
      background:#f7f6f3;
    }

    /* Option input overlay */
    .option-input-overlay{
      position:fixed;
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:12px;
      box-shadow:0 16px 48px rgba(0,0,0,0.2);
      padding:16px;
      width:300px;
      z-index:10003;
    }
    .option-input-overlay .title{
      color:#6b7280;
      font-size:13px;
      margin-bottom:12px;
      font-weight:600;
    }
    .option-input-field{
      width:100%;
      padding:12px 14px;
      border:2px solid #3b82f6;
      border-radius:8px;
      outline:none;
      font-size:14px;
      margin-bottom:16px;
    }
    .option-input-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .option-input-actions button{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:background .15s;
    }
    .option-input-actions .cancel{
      background:transparent;
      color:var(--text);
    }
    .option-input-actions .cancel:hover{
      background:#f7f6f3;
    }
    .option-input-actions .save{
      background:var(--blue);
      color:#fff;
    }
    .option-input-actions .save:hover{
      background:#2563eb;
    }

    /* Property value display in entry */
    .property-select-display{
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      padding:4px 0;
    }
    .property-select-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
    }

    .icon{
        width: 15px;
        height: 15px;
    }

  </style>
</head>
<body>
  <button id="btnOpenSidebar" class="button hamburger"><img src="icons/right_dir.png" class="icon" /></button>
  <div class="app">
    <aside class="sidebar">
      <!-- sticky header -->
      <div class="side-head">
        <div class="brand" id="brandArea">
          <div class="dot"></div>
          <div class="name">Soumikii'…</div>
          <div class="hover-controls">
            <button class="icon-pill" id="btnCollapse" title="Close sidebar"><img src="icons/back.png" class="icon" /></button>
            <button class="icon-pill" id="btnNewNote" title="New note"><img src="icons/editing.png" class="icon" /></button>
            <button class="icon-pill" id="btnChevron" title="Account"><img src="icons/down-arrow-black.png" class="icon"></button>
          </div>
        </div>

        <label class="search">
          <span style="opacity:.5"><img src="icons/search.png" class="icon" /></span>
          <input id="sidebarSearch" placeholder="Search" />
        </label>

        <div class="side-item active" data-static="home"><img src="icons/home.png" class="icon" /> <span class="txt" style="opacity:.5">Home</span></div>
        <div class="side-item" data-static="meetings"><img src="icons/transcription.png" class="icon" /> <span class="txt" style="opacity:.5">Meetings</span></div>
        <div class="side-item" data-static="ai"><img src="icons/face-id.png" class="icon" /> <span class="txt" style="opacity:.5">Notion AI</span></div>
        <div class="side-item" data-static="inbox"><img src="icons/inbox.png" class="icon" /> <span class="txt" style="opacity:.5">Inbox</span></div>
      </div>

      <!-- scrollable middle -->
      <div class="side-scroll">
        <!-- Favorites -->
        <div class="section-row" id="secFavorites">
          
          <div class="section-title">Favorites</div>
          <span class="chev" id="chevFavorites">⌄</span>
          <div class="section-controls">
            <button class="icon-pill" title="More"><img src="icons/dots.png" class="icon" /></button>
            <button class="icon-pill" id="favAdd" title="Add a page"><span style="opacity:.5">＋</span></button>
          </div>
        </div>
        <div id="favorites" class="fav-list section-content"></div>

        <!-- Workspace -->
        <div class="section-row" id="secWorkspace">
          
          <div class="section-title">Workspace</div>
          <span class="chev" id="chevWorkspace">⌄</span>
          <div class="section-controls">
            <button class="icon-pill" id="wsMore" title="More"><img src="icons/dots.png" class="icon" /></button>
            <button class="icon-pill" id="wsAdd" title="Add a page"><span style="opacity:.5">＋</span></button>
          </div>
        </div>
        <div id="tree" class="ws-pages section-content"></div>

        <!-- Shared -->
        <div class="section-row" id="secShared">
          
          <div class="section-title">Shared</div>
          <span class="chev" id="chevShared">⌄</span>
          <div class="section-controls">
            <button class="icon-pill" title="More"><img src="icons/dots.png" class="icon" /></button>
            <button class="icon-pill" id="sharedAdd" title="Add a page"><span style="opacity:.5">＋</span></button>
          </div>
        </div>
        <div id="sharedList" class="shared-list section-content"></div>

        <!-- Private -->
        <div class="section-row" id="secPrivate">
          
          <div class="section-title">Private</div>
          <span class="chev" id="chevPrivate">⌄</span>
          <div class="section-controls">
            <button class="icon-pill" title="More" id="privateMoreBtn"><img src="icons/dots.png" class="icon" /></button>
            <button class="icon-pill" id="privateAdd" title="Add a page"><span style="opacity:.5">＋</span></button>
          </div>
        </div>
        <div id="privateList" class="private-list section-content"></div>
        <div id="privateMoreMenu" class="dropdown">
          <div class="item" data-template="Getting Started">Getting started</div>
          <div class="item" data-template="Quick Note">Quick note</div>
          <div class="item" data-template="Task List">Task list</div>
          <div class="item" data-template="Journal">Journal</div>
          <div class="item" data-template="Reading List">Reading list</div>
          <div class="item" data-template="Personal Home">Personal home</div>
        </div>

        <!-- Notion apps -->
        <div class="section-row" id="secApps">
          <div class="section-title">Notion apps</div>
          <span class="chev"></span>
          <div class="section-controls"></div>
        </div>
        <div class="apps-list" id="appsList">
          <div class="node"><img src="icons/paperPlane.png" class="icon" /> Notion Mail</div>
          <div class="node"><img src="icons/calendar.png" class="icon" /> Notion Calendar</div>
          <div class="node"><img src="icons/notion.png" class="icon" /> Notion Desktop</div>
        </div>

        <!-- Settings / Marketplace / Trash -->
        <div class="settings-list" id="settingsList">
          <div class="node"><img src="icons/setting.png" class="icon" /> Settings</div>
          <div class="node"><img src="icons/shapes.png" class="icon" /> Marketplace</div>
          <div class="node"><img src="icons/bin.png" class="icon" /> Trash</div>
        </div>
      </div>

      <!-- sticky footer -->
      <div class="side-sep"></div>
      <div class="help-row side-foot"><img src="icons/question.png" class="icon" /> Help</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="crumbs" id="crumbs"></div>
        <div class="actions">
          <button class="button" id="btnShare" title="Share">Share</button>
          <button class="button" id="btnFavTop" title="Favorite">☆</button>
          <button class="button" id="btnMoreTop" title="More">⋯</button>
        </div>
      </div>
      <section class="content" id="content"></section>
    </main>
  </div>

  <!-- hidden inputs for cover/icon uploads -->
  <input id="fileCover" type="file" accept="image/*" class="hidden" />
  <input id="fileIcon" type="file" accept="image/*" class="hidden" />

  <script>
    const LS_KEY='notionlite_v1_light';
    const HOME_ID='HOME';
    const uid=(p='id')=>p+'_'+Math.random().toString(36).slice(2,9);

    function load(){
        const raw=localStorage.getItem(LS_KEY);
        if(raw){
            try{
            const parsed = JSON.parse(raw);
            // Ensure all required properties exist
            if(!parsed.privatePages) parsed.privatePages = [];
            if(!parsed.sharedPages) parsed.sharedPages = [];
            if(!parsed.expandedNodes) parsed.expandedNodes = {};
            if(!parsed.collapsedSections) parsed.collapsedSections = {};
            if(!parsed.visited) parsed.visited = [];
            if(!parsed.workspaces) parsed.workspaces = {};
            return parsed;
            } catch(e){
            localStorage.removeItem(LS_KEY);
            }
        }
        const wsId=uid('ws'); const pg=uid('pg');
        const state={
            currentWorkspaceId:wsId,
            currentPageId:HOME_ID,
            viewScope:'home',
            viewId:HOME_ID,
            visited:[],
            expandedNodes:{},
            collapsedSections:{},
            privatePages:[],
            sharedPages:[],
            workspaces:{[wsId]:{
                id:wsId,
                name:'Workspace 1',
                pages:{},
                rootOrder:[]
        }}
        };
        save(state); return state;
    }
    function save(s){localStorage.setItem(LS_KEY, JSON.stringify(s))}
    let state=load();
    const ws=()=>state.workspaces[state.currentWorkspaceId];
    const getPage=id=>ws().pages[id];

    // MIGRATION
    Object.values(ws().pages).forEach(p => {
      if((p.title||'').toLowerCase()==='task list' && p.board && !p.board.columns){
        p.board = {
          columns:[
            {id:'todo', label:'To Do', color:'red', tasks: p.board.todo || []},
            {id:'doing', label:'Doing', color:'amber', tasks: p.board.doing || []},
            {id:'done', label:'Done 🙌', color:'green', tasks: p.board.done || []}
          ]
        };
      }
    });
    save(state);

    // Refs
    const treeEl=document.getElementById('tree');
    const favEl=document.getElementById('favorites');
    const content=document.getElementById('content');
    const privateList=document.getElementById('privateList');
    const sharedList=document.getElementById('sharedList');
    const privateMenu=document.getElementById('privateMoreMenu');
    const privateMoreBtn=document.getElementById('privateMoreBtn');
    const fileCover=document.getElementById('fileCover');
    const fileIcon=document.getElementById('fileIcon');

    // FIX #2: Section collapse/expand functionality
    function initSectionToggles(){
      const sections = [
        {chev: 'chevFavorites', content: 'favorites', key: 'favorites'},
        {chev: 'chevWorkspace', content: 'tree', key: 'workspace'},
        {chev: 'chevShared', content: 'sharedList', key: 'shared'},
        {chev: 'chevPrivate', content: 'privateList', key: 'private'}
      ];
      
      sections.forEach(({chev, content, key}) => {
        const chevEl = document.getElementById(chev);
        const contentEl = document.getElementById(content);
        if(!chevEl || !contentEl) return;
        
        // Restore collapsed state
        if(state.collapsedSections[key]){
          chevEl.classList.add('collapsed');
          contentEl.classList.add('collapsed');
        }
        
        chevEl.onclick = (e) => {
          e.stopPropagation();
          const isCollapsed = chevEl.classList.toggle('collapsed');
          contentEl.classList.toggle('collapsed');
          state.collapsedSections[key] = isCollapsed;
          save(state);
        };
      });
    }

    // ---------- Context menu ----------
    let ctxEl = null;
    function closeCtx(){ if(ctxEl){ ctxEl.remove(); ctxEl=null; } }
    document.addEventListener('click', (e)=>{ if(ctxEl && !ctxEl.contains(e.target)) closeCtx(); });

    function openCtx(x, y, actions) {
      closeCtx();
      ctxEl = document.createElement('div');
      ctxEl.className = 'ctx';
      ctxEl.style.position = 'absolute'; // Ensure absolute positioning
      ctxEl.style.left = x + 'px';
      ctxEl.style.top  = y + 'px';
      const grp = document.createElement('div'); grp.className='grp'; grp.textContent='Page'; ctxEl.appendChild(grp);
      actions.forEach(a=>{
        const it = document.createElement('div'); it.className='item'; it.innerHTML = a.icon + ' ' + a.label;
        it.onclick = (e)=>{ e.stopPropagation(); closeCtx(); a.onClick?.(); };
        ctxEl.appendChild(it);
      });
      const meta = document.createElement('div'); meta.className='muted';
      meta.textContent = 'Last edited by Soumikiii · just now';
      ctxEl.appendChild(meta);
      document.body.appendChild(ctxEl);
    }

    // FIX #1: Updated renderFavorites with full node structure including controls
    function renderFavorites(){
      favEl.innerHTML='';
      const addFav = (p, scope, openFn) => {
        const wrapper = document.createElement('div');
        const el = document.createElement('div');
        el.className='node';
        
        // Check if this favorite is currently active
        if(state.viewScope===scope && state.viewId===p.id) el.classList.add('active');
        
        // Expand button (invisible but maintains structure)
        const expandBtn = document.createElement('span');
        expandBtn.className = 'node-expand';
        expandBtn.style.visibility = 'hidden';
        
        // Label with icon
        const label = document.createElement('span');
        label.className = 'node-label';
        
        const iconSpan = document.createElement('span');
        iconSpan.className = 'node-icon';
        iconSpan.textContent = p.icon || '📄';
        
        const titleSpan = document.createElement('span');
        titleSpan.textContent = p.title || 'Untitled';
        
        label.appendChild(iconSpan);
        label.appendChild(titleSpan);
        
        // Controls (+ and ... buttons)
        const controls = document.createElement('div');
        controls.className = 'node-controls';
        controls.innerHTML = `
          <button class="pill" data-tip="Add a page inside" data-act="add">＋</button>
          <button class="pill" data-act="more">⋯</button>
        `;
        
        el.appendChild(expandBtn);
        el.appendChild(label);
        el.appendChild(controls);
        
        // Click to open page
        el.addEventListener('click', (e) => {
          if(e.target.closest('.pill')) return;
          openFn();
        });
        
        // + Add child (finds original page and adds child there)
        controls.querySelector('[data-act="add"]').onclick = (e) => {
          e.stopPropagation();
          if(scope === 'workspace'){
            const id = uid('pg');
            ws().pages[id] = {id, title:'Untitled', parentId:p.id, children:[], favorite:false, blocks:[], icon:'', cover:'', body:''};
            p.children.push(id);
            state.expandedNodes[p.id] = true;
            save(state); renderTree(); renderFavorites(); openEditor('workspace', id);
          } else if(scope === 'private'){
            const newPage = {id:uid('priv'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
            p.children.push(newPage);
            state.expandedNodes[p.id] = true;
            save(state); renderPrivate(); renderFavorites(); openEditor('private', newPage.id);
          } else if(scope === 'shared'){
            const newPage = {id:uid('shr'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
            p.children.push(newPage);
            state.expandedNodes[p.id] = true;
            save(state); renderShared(); renderFavorites(); openEditor('shared', newPage.id);
          }
        };
        
        // ... More menu
        controls.querySelector('[data-act="more"]').onclick = (e) => {
          e.stopPropagation();
          const r = e.currentTarget.getBoundingClientRect();
          const isFav = !!p.favorite;
          const actions = [
            {icon:'☆', label: (isFav?'Remove from Favorites':'Add to Favorites'), onClick:()=>{
              p.favorite=!isFav; save(state); renderFavorites();
              if(scope === 'workspace') renderTree();
              else if(scope === 'private') renderPrivate();
              else if(scope === 'shared') renderShared();
            }},
            {icon:'🔗', label:'Copy link', onClick:()=>{ navigator.clipboard?.writeText('#'+(p.title||p.id)); }},
            {icon:'✏️', label:'Rename', onClick:()=>{
              const nv=prompt('Rename page',p.title||'Untitled'); if(!nv) return;
              p.title=nv; save(state);
              if(scope==='workspace'){ renderTree(); renderCrumbs(); renderFavorites(); }
              else if(scope==='private'){ renderPrivate(); renderCrumbs(); renderFavorites(); }
              else if(scope==='shared'){ renderShared(); renderCrumbs(); renderFavorites(); }
            }}
          ];
          openCtx(r.left, r.bottom+6, actions);
        };
        
        wrapper.appendChild(el);
        favEl.appendChild(wrapper);
      };
      
      if(ws() && ws().pages){
        Object.values(ws().pages).filter(p=>p.favorite).forEach(p=>addFav(p, 'workspace', ()=>openEditor('workspace', p.id)));
      }
      if(state.privatePages && Array.isArray(state.privatePages)){
        state.privatePages.filter(p=>p.favorite).forEach(p=>addFav(p, 'private', ()=>openEditor('private', p.id)));
      }
      if(state.sharedPages && Array.isArray(state.sharedPages)){
        state.sharedPages.filter(p=>p.favorite).forEach(p=>addFav(p, 'shared', ()=>openEditor('shared', p.id)));
      }
    }

    // ---------- Tree (Workspace) with proper nesting ----------
    function renderTree(){
      treeEl.innerHTML='';
      const roots = ws().rootOrder.filter(id => ws().pages[id] && ws().pages[id].parentId===null);
      roots.forEach(rid=>treeEl.appendChild(renderNode(ws().pages[rid],'workspace',null)));
    }

    function findInArray(arr,id){
      const dfs = (list, target) => {
        for (const p of list){
          if (p.id === target) return p;
          if (Array.isArray(p.children)){
            const hit = dfs(p.children, target);
            if (hit) return hit;
          }
        }
        return null;
      };
      return dfs(arr, id);
    }

    // FIXED: Proper nesting with expand/collapse arrows (workspace + private + shared)
    function renderNode(page, scope='workspace', parentRef=null){
      if(!Array.isArray(page.children)) page.children=[];
      
      const el=document.createElement('div');
      const wrapper = document.createElement('div');
      
      el.className='node';
      el.draggable=true;
      el.dataset.id=page.id;
      el.dataset.scope=scope;
      if(state.viewScope===scope && state.viewId===page.id) el.classList.add('active');

      const hasChildren = page.children?.length > 0;
      const isExpanded = state.expandedNodes[page.id];

      // Expand/collapse arrow (only shows on hover, replaces icon)
      const expandBtn = document.createElement('span');
      expandBtn.className = 'node-expand';
      if(isExpanded) expandBtn.classList.add('expanded');
      expandBtn.innerHTML = '▸';
      expandBtn.onclick = (e) => {
        e.stopPropagation();
        if(hasChildren) {
          state.expandedNodes[page.id] = !state.expandedNodes[page.id];
          save(state);
          // Re-render the appropriate scope
          if(scope === 'workspace') renderTree();
          else if(scope === 'private') renderPrivate();
          else if(scope === 'shared') renderShared();
        }
      };

      // Label with icon wrapped separately so chevron can replace it
      const label = document.createElement('span');
      label.className = 'node-label';
      
      const iconSpan = document.createElement('span');
      iconSpan.className = 'node-icon';
      // Show checkmark for Task List pages
      const isTaskList = (page.title||'').toLowerCase() === 'task list';
    //   iconSpan.textContent = isTaskList ? '✓' : (page.icon || '📄');
      if(isTaskList){
        iconSpan.textContent = '✓';
    } else if(page.icon && page.icon.includes('<img')){
        iconSpan.innerHTML = page.icon;
    } else {
        iconSpan.textContent = page.icon || '📄';
    }
      
      const titleSpan = document.createElement('span');
      titleSpan.textContent = page.title || 'Untitled';
      
      label.appendChild(iconSpan);
      label.appendChild(titleSpan);

      // Controls (only show on direct hover)
      const controls = document.createElement('div');
      controls.className = 'node-controls';
      controls.innerHTML = `
        <button class="pill" data-tip="Add a page inside" data-act="add">＋</button>
        <button class="pill" data-act="more">⋯</button>
      `;

      el.appendChild(expandBtn);
      el.appendChild(label);
      el.appendChild(controls);

      // Open editor
      el.addEventListener('click',(e)=>{
        if(e.target.closest('.pill') || e.target.closest('.node-expand')) return;
        openEditor(scope, page.id);
      });

      // Drag & drop (simplified - reorder only)
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({id:page.id, scope, parentId:(scope==='workspace'?page.parentId:null)}));
      });
      el.addEventListener('dragover', e=>{ e.preventDefault(); el.classList.add('drop-before'); });
      el.addEventListener('dragleave', ()=>{ el.classList.remove('drop-before'); });
      el.addEventListener('drop', e=>{
        e.preventDefault(); el.classList.remove('drop-before');
        const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
        if(!data.id || data.scope!==scope || data.id === page.id) return;

        if(scope==='workspace'){
          const from = ws().pages[data.id];
          const to = ws().pages[page.id];
          if(from.parentId !== to.parentId) return; // Same parent only

          const list = from.parentId===null ? ws().rootOrder : ws().pages[from.parentId].children;
          const fi=list.indexOf(data.id), ti=list.indexOf(page.id);
          if(fi<0 || ti<0) return;
          list.splice(fi,1); list.splice(ti,0,data.id);
          save(state); renderTree();
        } else if(scope==='private'){
          // For private pages, we need to find them in the tree structure
          const findAndReorder = (arr, fromId, toId, parentArr = null) => {
            // Check if both items are in this array level
            const fi = arr.findIndex(p => p.id === fromId);
            const ti = arr.findIndex(p => p.id === toId);
            
            if(fi >= 0 && ti >= 0){
              // Both found at this level - reorder
              const [item] = arr.splice(fi, 1);
              arr.splice(ti, 0, item);
              return true;
            }
            
            // Otherwise search in children
            for(let p of arr){
              if(p.children?.length && findAndReorder(p.children, fromId, toId, p)){
                return true;
              }
            }
            return false;
          };
          
          findAndReorder(state.privatePages, data.id, page.id);
          save(state); renderPrivate();
        } else if(scope==='shared'){
          const findAndReorder = (arr, fromId, toId) => {
            const fi = arr.findIndex(p => p.id === fromId);
            const ti = arr.findIndex(p => p.id === toId);
            
            if(fi >= 0 && ti >= 0){
              const [item] = arr.splice(fi, 1);
              arr.splice(ti, 0, item);
              return true;
            }
            
            for(let p of arr){
              if(p.children?.length && findAndReorder(p.children, fromId, toId)){
                return true;
              }
            }
            return false;
          };
          
          findAndReorder(state.sharedPages, data.id, page.id);
          save(state); renderShared();
        }
      });

      // + Add child
      controls.querySelector('[data-act="add"]').onclick=(e)=>{
        e.stopPropagation();
        if(scope==='workspace'){
          const id=uid('pg');
          ws().pages[id]={id,title:'Untitled',parentId:page.id,children:[],favorite:false,blocks:[],icon:'',cover:'',body:''};
          page.children.push(id);
          state.expandedNodes[page.id] = true; // Auto-expand when adding child
          save(state); renderTree(); openEditor('workspace', id);
        } else if(scope==='private'){
          const newPage={id:uid('priv'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
          page.children.push(newPage);
          state.expandedNodes[page.id] = true; // Auto-expand when adding child
          save(state); renderPrivate(); openEditor('private', newPage.id);
        } else if(scope==='shared'){
          const newPage={id:uid('shr'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
          page.children.push(newPage);
          state.expandedNodes[page.id] = true; // Auto-expand when adding child
          save(state); renderShared(); openEditor('shared', newPage.id);
        }
      };

      // … More menu
      controls.querySelector('[data-act="more"]').onclick=(e)=>{
        e.stopPropagation();
        const r=e.currentTarget.getBoundingClientRect();
        const isFav = !!page.favorite;
        const actions=[
          {icon:'☆',label: (isFav?'Remove from Favorites':'Add to Favorites'), onClick:()=>{
            page.favorite=!isFav; save(state); renderFavorites();
            // Re-render the appropriate scope
            if(scope === 'workspace') renderTree();
            else if(scope === 'private') renderPrivate();
            else if(scope === 'shared') renderShared();
          }},
          {icon:'🔗',label:'Copy link', onClick:()=>{ navigator.clipboard?.writeText('#'+(page.title||page.id)); }},
          {icon:'📄',label:'Duplicate', onClick:()=>{
            if(scope==='workspace'){
              const id=uid('pg');
              ws().pages[id]={...page,id,title:(page.title||'Untitled')+' (copy)',children:[]};
              if(page.parentId==null){ ws().rootOrder.push(id); }
              else { ws().pages[page.parentId].children.push(id); }
              save(state); renderTree();
            } else if(scope==='private'){
              const newPage={...page,id:uid('priv'),title:(page.title||'Untitled')+' (copy)',children:[]};
              state.privatePages.push(newPage);
              save(state); renderPrivate();
            } else if(scope==='shared'){
              const newPage={...page,id:uid('shr'),title:(page.title||'Untitled')+' (copy)',children:[]};
              state.sharedPages.push(newPage);
              save(state); renderShared();
            }
          }},
          {icon:'✏️',label:'Rename', onClick:()=>{
            const nv=prompt('Rename page',page.title||'Untitled'); if(!nv) return;
            page.title=nv; save(state);
            if(scope==='workspace'){ renderTree(); renderCrumbs(); }
            else if(scope==='private'){ renderPrivate(); renderCrumbs(); }
            else if(scope==='shared'){ renderShared(); renderCrumbs(); }
          }},
          {icon:'🗑️',label:'Move to Trash', onClick:()=>{
            if(scope==='workspace'){
              if(page.parentId==null){
                const idx=ws().rootOrder.indexOf(page.id); if(idx>-1) ws().rootOrder.splice(idx,1);
              }else{
                const l=ws().pages[page.parentId].children; const i=l.indexOf(page.id); if(i>-1) l.splice(i,1);
              }
              delete ws().pages[page.id];
              if(state.viewScope==='workspace' && state.viewId===page.id) { state.viewId=HOME_ID; state.viewScope='home'; }
              save(state); renderTree(); renderFavorites(); renderCrumbs(); render();
            } else if(scope==='private'){
              // Helper function to recursively remove page and its children
              const removePage = (pageToRemove, parentArray) => {
                const idx = parentArray.findIndex(p => p.id === pageToRemove.id);
                if(idx > -1) parentArray.splice(idx, 1);
              };
              const findAndRemove = (arr, targetId, parent = null) => {
                for(let i = 0; i < arr.length; i++){
                  if(arr[i].id === targetId){
                    arr.splice(i, 1);
                    return true;
                  }
                  if(arr[i].children?.length && findAndRemove(arr[i].children, targetId, arr[i])){
                    return true;
                  }
                }
                return false;
              };
              findAndRemove(state.privatePages, page.id);
              if(state.viewScope==='private' && state.viewId===page.id){ state.viewId=HOME_ID; state.viewScope='home'; }
              save(state); renderPrivate(); renderFavorites(); render();
            } else if(scope==='shared'){
              const findAndRemove = (arr, targetId) => {
                for(let i = 0; i < arr.length; i++){
                  if(arr[i].id === targetId){
                    arr.splice(i, 1);
                    return true;
                  }
                  if(arr[i].children?.length && findAndRemove(arr[i].children, targetId)){
                    return true;
                  }
                }
                return false;
              };
              findAndRemove(state.sharedPages, page.id);
              if(state.viewScope==='shared' && state.viewId===page.id){ state.viewId=HOME_ID; state.viewScope='home'; }
              save(state); renderShared(); renderFavorites(); render();
            }
          }},
          {icon:'🡥',label:'Open in new tab', onClick:()=>window.open('#','_blank')}
        ];
        openCtx(r.left, r.bottom+6, actions);
      };

      wrapper.appendChild(el);

      // Render children if expanded (for all scopes)
      if(hasChildren && isExpanded){
        const childContainer = document.createElement('div');
        childContainer.className = 'children';
        
        if(scope === 'workspace'){
          // Workspace: children are IDs, need to look them up
          page.children.forEach(cid => {
            const child = getPage(cid);
            if(child) childContainer.appendChild(renderNode(child, 'workspace', page.id));
          });
        } else {
          // Private/Shared: children are objects themselves
          page.children.forEach(childObj => {
            childContainer.appendChild(renderNode(childObj, scope, page.id));
          });
        }
        
        wrapper.appendChild(childContainer);
      }

      return wrapper;
    }

    // Private & Shared lists
    function renderPrivate(){
        privateList.innerHTML='';
        if(state.privatePages && Array.isArray(state.privatePages)){
            state.privatePages.forEach(p=>privateList.appendChild(renderNode(p,'private',null)));
        }
        const more = document.createElement('div');
        more.className = 'node';
        more.innerHTML = '<img src="icons/dots.png" class="icon" /> More';
        more.title = 'All private pages';
        more.onclick = () => openPrivateOverlay();
        privateList.appendChild(more);
    }
    function renderShared(){
        sharedList.innerHTML='';
        if(state.sharedPages && Array.isArray(state.sharedPages)){
            state.sharedPages.forEach(p=>sharedList.appendChild(renderNode(p,'shared',null)));
        }
    }

    // --- Private overlay ---
    function openPrivateOverlay(){
      if(document.getElementById('privDock')) return;
      
      const back = document.createElement('div'); 
      back.className='priv-backdrop'; 
      back.id='privBack';
      
      const panel = document.createElement('div'); 
      panel.className='priv-dock opening'; 
      panel.id='privDock';
      
      // Header
      const header = document.createElement('div');
      header.className = 'header';
      header.innerHTML = `
        <div class="title">Private</div>
        <div class="close-btn" id="closePriv">✕</div>
      `;
      
      // Search input
      const searchInput = document.createElement('input');
      searchInput.className = 'search-input';
      searchInput.id = 'privSearch';
      searchInput.placeholder = 'Search for a page...';
      
      // Pages section (contains both pages and templates)
      const pagesSection = document.createElement('div');
      pagesSection.className = 'pages-section';
      pagesSection.id = 'privList';
      
      panel.appendChild(header);
      panel.appendChild(searchInput);
      panel.appendChild(pagesSection);
      
      document.body.appendChild(back);
      document.body.appendChild(panel);
      
      // Trigger animation
      requestAnimationFrame(() => {
        back.classList.add('visible');
      });
      
      const close = () => { 
        panel.classList.remove('opening');
        back.style.opacity = '0';
        panel.style.transform = 'translateX(-100%)';
        setTimeout(() => {
          if(back.parentNode) back.remove(); 
          if(panel.parentNode) panel.remove(); 
        }, 300);
      };    
      back.onclick = close;
      header.querySelector('#closePriv').onclick = close;
      
      // Render pages list with templates at the end
      const renderList = (query = '') => {
        pagesSection.innerHTML = '';
        
        const renderPageItem = (page, depth = 0) => {
          // Filter by search query
          const matchesQuery = !query || page.title.toLowerCase().includes(query.toLowerCase());
          
          if(matchesQuery) {
            const item = document.createElement('div');
            item.className = 'page-item';
            if(depth > 0) {
              item.style.marginLeft = (depth * 20) + 'px';
            }
            
            // Expand chevron (for pages with children)
            const chevron = document.createElement('span');
            chevron.className = 'expand-chev';
            chevron.textContent = '›';
            if(page.children && page.children.length > 0) {
              chevron.style.opacity = '0.5';
            }
            
            // Page icon
            const icon = document.createElement('span');
            icon.className = 'page-icon';
            icon.textContent = page.icon || '📄';
            
            // Page title container
            const titleContainer = document.createElement('div');
            titleContainer.className = 'page-title';
            titleContainer.style.display = 'flex';
            titleContainer.style.flexDirection = 'column';
            
            const title = document.createElement('span');
            title.textContent = page.title || 'Untitled';
            titleContainer.appendChild(title);
            
            // Nested indicator
            if(page.children && page.children.length > 0) {
              const nested = document.createElement('span');
              nested.className = 'page-nested';
              nested.textContent = page.children.length === 0 ? 'No pages inside' : 
                                  page.children.length === 1 ? '1 page inside' : 
                                  `${page.children.length} pages inside`;
              titleContainer.appendChild(nested);
            }
            
            // Controls (... and +)
            const controls = document.createElement('div');
            controls.className = 'page-controls';
            
            const moreBtn = document.createElement('span');
            moreBtn.className = 'ctrl-btn';
            moreBtn.textContent = '⋯';
            moreBtn.onclick = (e) => {
              e.stopPropagation();
              const r = moreBtn.getBoundingClientRect();
              const isFav = !!page.favorite;
              const actions = [
                {icon:'☆', label: (isFav?'Remove from Favorites':'Add to Favorites'), onClick:()=>{
                  page.favorite=!isFav; save(state); renderFavorites(); renderPrivate(); renderList(query);
                }},
                {icon:'✏️', label:'Rename', onClick:()=>{
                  const nv=prompt('Rename page',page.title||'Untitled'); if(!nv) return;
                  page.title=nv; save(state); renderPrivate(); renderCrumbs(); renderList(query);
                }},
                {icon:'🗑️', label:'Move to Trash', onClick:()=>{
                  const findAndRemove = (arr, targetId) => {
                    for(let i = 0; i < arr.length; i++){
                      if(arr[i].id === targetId){
                        arr.splice(i, 1);
                        return true;
                      }
                      if(arr[i].children?.length && findAndRemove(arr[i].children, targetId)){
                        return true;
                      }
                    }
                    return false;
                  };
                  findAndRemove(state.privatePages, page.id);
                  save(state); renderPrivate(); renderFavorites(); renderList(query);
                }}
              ];
              openCtx(r.left, r.bottom + 6, actions);
            };
            
            const addBtn = document.createElement('span');
            addBtn.className = 'ctrl-btn';
            addBtn.textContent = '＋';
            addBtn.onclick = (e) => {
              e.stopPropagation();
              const newPage = {id:uid('priv'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
              if(!page.children) page.children = [];
              page.children.push(newPage);
              save(state);
              renderPrivate();
              renderList(query);
            };
            
            controls.appendChild(moreBtn);
            controls.appendChild(addBtn);
            
            item.appendChild(chevron);
            item.appendChild(icon);
            item.appendChild(titleContainer);
            item.appendChild(controls);
            
            // Click to open page
            item.onclick = () => {
              close();
              openEditor('private', page.id);
            };
            
            pagesSection.appendChild(item);
          }
          
          // Render children recursively
          if(page.children && page.children.length > 0) {
            page.children.forEach(child => renderPageItem(child, depth + 1));
          }
        };
        
        // Render all private pages
        if(state.privatePages && Array.isArray(state.privatePages)){
            state.privatePages.forEach(page => renderPageItem(page, 0));
        }
        
        // Add templates at the end (only if no search query)
        if(!query) {
          const templates = [
            {icon:'📘', name:'Getting Started'},
            {icon:'📝', name:'Quick Note'},
            {icon:'<img src="icons/check-mark.png" style="width:16px;height:16px;vertical-align:middle">', name:'Task List'},
            {icon:'📔', name:'Journal'},
            {icon:'📚', name:'Reading List'},
            {icon:'🏠', name:'Personal Home'}
          ];
          
          templates.forEach(template => {
            const item = document.createElement('div');
            item.className = 'page-item';
            
            const chevron = document.createElement('span');
            chevron.className = 'expand-chev';
            chevron.textContent = '';
            
            const icon = document.createElement('span');
            icon.className = 'page-icon';
            icon.innerHTML = template.icon;
            
            const titleContainer = document.createElement('div');
            titleContainer.className = 'page-title';
            titleContainer.textContent = template.name;
            
            const controls = document.createElement('div');
            controls.className = 'page-controls';
            controls.innerHTML = '<span style="width:48px"></span>'; // Spacer for alignment
            
            item.appendChild(chevron);
            item.appendChild(icon);
            item.appendChild(titleContainer);
            item.appendChild(controls);
            
            item.onclick = () => {
              const p = {id:uid('priv'), title:template.name, children:[], icon:template.icon, cover:'', body:'', favorite:false};
              state.privatePages.push(p);
              save(state);
              renderPrivate();
              close();
              openEditor('private', p.id);
            };
            
            pagesSection.appendChild(item);
          });
        }
      };
      
      renderList();
      searchInput.oninput = (e) => renderList(e.target.value);
    }

    // Navigation
    function openEditor(scope,id){
      state.viewScope=scope;
      state.viewId=id;
      if(scope==='workspace'){
        state.currentPageId=id;
        state.visited=[id,...state.visited.filter(x=>x!==id)].slice(0,8);
      }
      save(state); render();
    }
    function setHome(){ state.viewScope='home'; state.viewId=HOME_ID; state.currentPageId=HOME_ID; save(state); render(); }
    document.querySelectorAll('.side-item').forEach(it=>{
      it.addEventListener('click',()=>{
        document.querySelectorAll('.side-item').forEach(n=>n.classList.remove('active'));
        it.classList.add('active');
        setHome();
      })
    });

    // Section controls
    document.getElementById('wsAdd').onclick=()=>{
      const id=uid('pg'); ws().pages[id]={id,title:'Untitled',parentId:null,children:[],favorite:false,blocks:[],icon:'',cover:'',body:''}; ws().rootOrder.push(id); save(state); renderTree(); openEditor('workspace',id);
    };
    document.getElementById('wsMore').onclick=()=>alert('Workspace options (stub)');

    document.getElementById('sharedAdd').onclick=()=>{
      const p={id:uid('shr'), title:'Shared page', children:[], icon:'', cover:'', body:'', favorite:false};
      state.sharedPages.push(p); save(state); renderShared(); openEditor('shared', p.id);
    };

    document.getElementById('privateAdd').onclick=()=>{
      const p={id:uid('priv'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
      state.privatePages.push(p); save(state); renderPrivate(); openEditor('private', p.id);
    };

    privateMoreBtn.onclick=(e)=>{ e.stopPropagation(); privateMenu.style.display = privateMenu.style.display==='flex' ? 'none':'flex'; };
    document.addEventListener('click', (e)=>{ if(!privateMenu.contains(e.target) && e.target!==privateMoreBtn){ privateMenu.style.display='none'; }});
    privateMenu.querySelectorAll('.item').forEach(it=>{
      it.onclick=()=>{ const name=it.getAttribute('data-template'); const p={id:uid('priv'), title:name, children:[], icon:'', cover:'', body:'', favorite:false}; state.privatePages.push(p); save(state); renderPrivate(); privateMenu.style.display='none'; openEditor('private',p.id); };
    });

    // Breadcrumbs
    const crumbsEl=document.getElementById('crumbs');
    function renderCrumbs(){
        crumbsEl.innerHTML='';
        const btnShare = document.getElementById('btnShare');
        const btnFavTop = document.getElementById('btnFavTop');
        const btnMoreTop = document.getElementById('btnMoreTop');
        
        if(state.viewScope==='home'){ 
          crumbsEl.textContent=''; 
          // Hide Share and Favorite buttons on Home page, show only More (...)
          btnShare.style.display='none';
          btnFavTop.style.display='none';
          btnMoreTop.style.display='inline-flex';
          return; 
        }
        
        // Show all buttons on regular pages
        btnShare.style.display='inline-flex';
        btnFavTop.style.display='inline-flex';
        btnMoreTop.style.display='inline-flex';
        
        // Build breadcrumb trail
        const breadcrumbs = [];
        
        if(state.viewScope === 'workspace'){
          // Get the full parent chain for workspace
          let currentId = state.viewId;
          while(currentId){
            const page = getPage(currentId);
            if(!page) break;
            breadcrumbs.unshift({
              id: currentId,
              title: page.title || 'Untitled',
              icon: page.icon || '',
              scope: 'workspace'
            });
            currentId = page.parentId;
          }
        } else if(state.viewScope === 'private'){
          // Get the full parent chain for private
          const buildPrivateChain = (pages, targetId, chain = []) => {
            for(const page of pages){
              if(page.id === targetId){
                chain.unshift({
                  id: page.id,
                  title: page.title || 'Untitled',
                  icon: page.icon || '',
                  scope: 'private'
                });
                return true;
              }
              if(page.children && page.children.length > 0){
                const found = buildPrivateChain(page.children, targetId, chain);
                if(found){
                  chain.unshift({
                    id: page.id,
                    title: page.title || 'Untitled',
                    icon: page.icon || '',
                    scope: 'private'
                  });
                  return true;
                }
              }
            }
            return false;
          };
          buildPrivateChain(state.privatePages, state.viewId, breadcrumbs);
        } 
        else if(state.viewScope === 'shared'){
          // Get the full parent chain for shared
          const buildSharedChain = (pages, targetId, chain = []) => {
            for(const page of pages){
              if(page.id === targetId){
                chain.unshift({
                  id: page.id,
                  title: page.title || 'Untitled',
                  icon: page.icon || '',
                  scope: 'shared'
                });
                return true;
              }
              if(page.children && page.children.length > 0){
                const found = buildSharedChain(page.children, targetId, chain);
                if(found){
                  chain.unshift({
                    id: page.id,
                    title: page.title || 'Untitled',
                    icon: page.icon || '',
                    scope: 'shared'
                  });
                  return true;
                }
              }
            }
            return false;
          };
          buildSharedChain(state.sharedPages, state.viewId, breadcrumbs);
        }

        // Check if current page is a root private page
        const isRootPrivatePage = state.viewScope === 'private' && state.privatePages.some(p => p.id === state.viewId);
        
        // Render breadcrumbs
        breadcrumbs.forEach((crumb, index) => {
          if(index > 0){
            // Add separator
            const sep = document.createElement('span');
            sep.textContent = ' / ';
            sep.style.margin = '0 4px';
            sep.style.opacity = '0.5';
            crumbsEl.appendChild(sep);
          }
          
          const crumbEl = document.createElement('span');
          crumbEl.innerHTML = (crumb.icon ? crumb.icon + ' ' : '') + crumb.title;
          crumbEl.style.cursor = 'pointer';
          crumbEl.style.padding = '2px 4px';
          crumbEl.style.borderRadius = '4px';
          crumbEl.style.transition = 'background 0.15s';
          
          // Make clickable to navigate
          crumbEl.onclick = () => {
            openEditor(crumb.scope, crumb.id);
          };
          crumbEl.onmouseenter = () => {
            crumbEl.style.background = '#eef2f6';
          };
          crumbEl.onmouseleave = () => {
            crumbEl.style.background = '';
          };
          
          crumbsEl.appendChild(crumbEl);
          
          // Add "Private" badge after the page name if it's a root private page
          if(isRootPrivatePage && index === breadcrumbs.length - 1){
            const lockIcon = document.createElement('span');
            lockIcon.innerHTML = '<img src="icons/padlock.png" class="icon" style="width:15px;height:15px;margin-top:2px">';
            lockIcon.style.opacity = '0.5';
            lockIcon.style.marginLeft = '8px';
            crumbsEl.appendChild(lockIcon);
            const privateText = document.createElement('span');
            privateText.textContent = ' Private';
            privateText.style.opacity = '0.7';
            crumbsEl.appendChild(privateText);
            
            const chevron = document.createElement('span');
            chevron.innerHTML = ' ⌄';
            chevron.style.opacity = '0.5';
            chevron.style.display = 'inline-flex';
            chevron.style.alignItems = 'center';
            chevron.style.marginLeft = '2px';
            chevron.style.marginBottom = '7px';
            crumbsEl.appendChild(chevron);
          }
        });
    }

    function getTitle(scope,id){
      if(scope==='workspace') return getPage(id)?.title;
      if(scope==='private') return findInArray(state.privatePages,id)?.title;
      if(scope==='shared') return findInArray(state.sharedPages,id)?.title;
      return 'Home';
    }
    function getIcon(scope,id){
      if(scope==='workspace') return getPage(id)?.icon || '';
      if(scope==='private')   return findInArray(state.privatePages,id)?.icon || '';
      if(scope==='shared')    return findInArray(state.sharedPages,id)?.icon || '';
      return '';
    }

    function renderHome(){
      content.innerHTML='';
      const hero=document.createElement('div'); hero.className='home-hero'; hero.textContent='Good afternoon'; content.appendChild(hero);
      const sec1=document.createElement('div'); sec1.className='home-section-title'; sec1.innerHTML='<img src="icons/clock.png" class="icon" /> Recently visited'; content.appendChild(sec1);
      const row=document.createElement('div'); row.className='card-row'; content.appendChild(row);
      (state.visited.length? state.visited: ws().rootOrder).slice(0,5).forEach(id=>{
        const p=getPage(id)||{title:'New page'};
        const card=document.createElement('div'); card.className='page-card';
        card.innerHTML=`<div class="thumb"></div><div class="body"><div class="title">${p.title||'Untitled'}</div><div class="meta">1d ago</div></div>`;
        card.onclick=()=>openEditor('workspace', id);
        row.appendChild(card)
      });
      const sec2=document.createElement('div'); sec2.className='home-section-title'; sec2.innerHTML='<img src="icons/calendar.png" class="icon" /> Upcoming events'; content.appendChild(sec2);
      const up=document.createElement('div'); up.className='upcoming'; up.innerHTML=`<div class="grid"><div class="panel">Connect AI Meeting Notes with your Calendar events<br/><br/><a href="#" onclick="alert('Stub: connect calendar')">Connect Notion Calendar</a></div><div class="panel">Today · Team standup (9 AM · Office)<br/>Sat · Project check-in (10 AM · Office)</div></div>`;
      content.appendChild(up);
    }

    // Icon tray
    function openIconTray(onPick){
      const tray=document.createElement('div');
      tray.className='icon-tray';
      tray.innerHTML=`
        <div class="tabs">
          <div class="tab active" data-t="emoji">Emoji</div>
          <div class="tab" data-t="upload">Upload</div>
          <div style="margin-left:auto;cursor:pointer" id="trayClose">✕</div>
        </div>
        <div id="emojiPane">
          <div class="icon-grid" id="emojiGrid"></div>
        </div>
        <div id="uploadPane" class="hidden">
          <input id="iconUpload" type="file" accept="image/*"/>
          <div class="footer"><button id="useUpload" class="button">Use</button></div>
        </div>
      `;
      const EMOJIS='😀 😃 😄 😁 😆 😅 😂 🙂 🙃 😉 😊 😇 🥰 😍 🤩 😘 😗 😙 😚 😋 😛 😝 😜 🤪 🤗 🤔 🤨 🫡 😐 😑 😶 🙄 😏 😣 😥 😮 🤐 😯 😪 😫 🥱 😴 😌 😛 🤓 🥳 🎉 📚 🧠 📝 🧪 💡 🔧 🛠️ 🧰 🗂️ 📦 📌 📎 📈 📊 🗒️ 📅 📁 🗃️ 🗳️'.split(/\s+/);
      const grid=tray.querySelector('#emojiGrid');
      EMOJIS.forEach(e=>{ const d=document.createElement('div'); d.textContent=e; d.onclick=()=>{ onPick(e); tray.remove(); }; grid.appendChild(d); });
      const tabs=tray.querySelectorAll('.tab');
      tabs.forEach(t=>t.onclick=()=>{
        tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
        tray.querySelector('#emojiPane').classList.toggle('hidden', t.dataset.t!=='emoji');
        tray.querySelector('#uploadPane').classList.toggle('hidden', t.dataset.t!=='upload');
      });
      tray.querySelector('#trayClose').onclick=()=>tray.remove();
      tray.querySelector('#useUpload').onclick=()=>{
        const f=tray.querySelector('#iconUpload').files?.[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{ onPick(`🖼️`); tray.remove(); }; r.readAsDataURL(f);
      };
      document.body.appendChild(tray);
    }

    // FIX #3: Show page preview on hover
    // FIX #3: Show page preview on hover
    function showPagePreview(linkElement, page, scope){
      // Remove any existing preview
      const existing = document.querySelector('.page-preview-backdrop');
      if(existing) existing.remove();
      const existingPreview = document.querySelector('.page-preview');
      if(existingPreview) existingPreview.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'page-preview-backdrop';
      
      const preview = document.createElement('div');
      preview.className = 'page-preview';
      
      // Position the preview below the link
      const rect = linkElement.getBoundingClientRect();
      preview.style.left = rect.left + 'px';
      preview.style.top = (rect.bottom + 8) + 'px';
      
      const icon = document.createElement('div');
      icon.className = 'page-preview-icon';
      icon.textContent = page.icon || '📄';
      
      const breadcrumbs = document.createElement('div');
      breadcrumbs.className = 'page-preview-breadcrumbs';
      // Get parent path
      let parentTitle = '';
      if(scope === 'workspace'){
        const currentPage = getPage(state.viewId);
        if(currentPage) parentTitle = currentPage.title || 'Untitled';
      } else if(scope === 'private'){
        const currentPage = findInArray(state.privatePages, state.viewId);
        if(currentPage) parentTitle = currentPage.title || 'Untitled';
      } else if(scope === 'shared'){
        const currentPage = findInArray(state.sharedPages, state.viewId);
        if(currentPage) parentTitle = currentPage.title || 'Untitled';
      }
      breadcrumbs.textContent = `New page / ${parentTitle}`;
      
      const title = document.createElement('div');
      title.className = 'page-preview-title';
      title.textContent = page.title || 'Untitled';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'page-preview-content';
      contentDiv.textContent = page.body || 'No content yet...';
      
      preview.appendChild(icon);
      preview.appendChild(breadcrumbs);
      preview.appendChild(title);
      preview.appendChild(contentDiv);
      
      document.body.appendChild(backdrop);
      document.body.appendChild(preview);
      
      return {backdrop, preview};
    }
    
    function hidePagePreview() {
      const backdrop = document.querySelector('.page-preview-backdrop');
      const preview = document.querySelector('.page-preview');
      if(backdrop) backdrop.remove();
      if(preview) preview.remove();
    }

    // Task detail sidebar
    // Task detail sidebar
    function openTaskDetail(task, column, scope, pageId){
      // Remove existing
      const existing=document.querySelector('.task-detail-sidebar');
      if(existing) existing.remove();
      const existingBackdrop=document.querySelector('.task-detail-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop=document.createElement('div');
      backdrop.className='task-detail-backdrop';
      
      const sidebar=document.createElement('div');
      sidebar.className='task-detail-sidebar';
      
      // Header
      const header=document.createElement('div');
      header.className='task-detail-header';
      header.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px">
          <button class="close-btn" id="closeTaskDetail">←</button>
          <button class="close-btn" id="maximizeTask">⇱</button>
        </div>
      `;
      
      // Body
      const body=document.createElement('div');
      body.className='task-detail-body';
      
      // Task title (placeholder initially)
      const titleInput=document.createElement('input');
      titleInput.className='task-detail-title';
      titleInput.value=task.title||'';
      titleInput.placeholder='New page';
      titleInput.style.color=task.title?'var(--text)':'#d1d5db';
      titleInput.onfocus=()=>{
        if(!task.title){
          titleInput.style.color='var(--text)';
        }
      };
      titleInput.onblur=()=>{
        if(!task.title){
          titleInput.style.color='#d1d5db';
          titleInput.value='New page';
        }
      };
      titleInput.oninput=()=>{
        task.title=titleInput.value;
        titleInput.style.color='var(--text)';
        save(state);
        renderEditor(scope,pageId);
      };
      body.appendChild(titleInput);
      
      // Properties container
      const propsContainer=document.createElement('div');
      propsContainer.style.marginBottom='24px';
      
      // Date Created
      const dateCreated=document.createElement('div');
      dateCreated.className='task-property';
      dateCreated.innerHTML=`
        <div class="task-property-label">
          <span>🕐</span> Date Created
        </div>
        <div class="task-property-value">
          ${new Date(task.createdAt||Date.now()).toLocaleString('en-US', {
            month:'long', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit', hour12:true
          })}
        </div>
      `;
      propsContainer.appendChild(dateCreated);
      
      // Status
      const statusProp=document.createElement('div');
      statusProp.className='task-property';
      const statusBadge=document.createElement('span');
      statusBadge.className=`task-status-badge ${column.id}`;
      statusBadge.textContent=column.label;
      statusProp.innerHTML=`
        <div class="task-property-label">
          <span>⊙</span> Status
        </div>
        <div class="task-property-value"></div>
      `;
      statusProp.querySelector('.task-property-value').appendChild(statusBadge);
      propsContainer.appendChild(statusProp);
      
      // Tags property
      const tagsProp=document.createElement('div');
      tagsProp.className='task-property';
      tagsProp.innerHTML=`
        <div class="task-property-label">
          <span>≡</span> Tags
        </div>
        <div class="task-property-value" style="color:#9aa1aa">
          Empty
        </div>
      `;
      propsContainer.appendChild(tagsProp);
      
      // Text property
      // const textProp=document.createElement('div');
      // textProp.className='task-property';
      // textProp.innerHTML=`
      //   <div class="task-property-label">
      //     <span>📝</span> Text
      //   </div>
      //   <div class="task-property-value" style="color:#9aa1aa">
      //     Empty
      //   </div>
      // `;
      // propsContainer.appendChild(textProp);
      
      // Add property button
      const addProp=document.createElement('div');
      addProp.className='add-property-btn';
      addProp.innerHTML='<span>＋</span> Add a property';
      propsContainer.appendChild(addProp);
      
      body.appendChild(propsContainer);
      
      // Comments section (above content)
      const comments=document.createElement('div');
      comments.className='task-comments-section';
      comments.style.marginBottom='16px';
      comments.innerHTML=`
        <h4 style="margin-bottom:12px;font-size:14px;font-weight:600">Comments</h4>
        <div style="display:flex;align-items:center;gap:12px;color:#9aa1aa;font-size:14px;padding:12px;background:var(--panel-2);border-radius:8px;cursor:pointer">
          <span style="font-size:20px">👤</span>
          <span>Add a comment...</span>
        </div>
      `;
      body.appendChild(comments);
      
      // Content area with visible placeholder and template options
      const contentArea=document.createElement('div');
      contentArea.style.marginBottom='24px';
      
      // Show existing content or placeholder with template options
      if(task.body && task.body.trim()){
        // Has content - show editable area
        const contentEditor=document.createElement('div');
        contentEditor.contentEditable='true';
        contentEditor.style.cssText='min-height:150px;outline:none;padding:12px 0;line-height:1.6;color:var(--text)';
        contentEditor.textContent=task.body;
        
        contentEditor.oninput=()=>{
          task.body=contentEditor.textContent;
          save(state);
          renderEditor(scope,pageId);
        };
        
        contentArea.appendChild(contentEditor);
      } else {
        // No content - show template selection area (clickable to activate editor)
        const placeholderSection=document.createElement('div');
        placeholderSection.style.cssText='padding:20px 0;cursor:text';
        
        // Template options (visible by default)
        const templateHint=document.createElement('div');
        templateHint.style.cssText='color:#9aa1aa;font-size:13px;margin-bottom:12px';
        templateHint.textContent='Press Enter to continue with an empty page, or pick a template (↑↓ to select)';
        placeholderSection.appendChild(templateHint);
        
        const templates=document.createElement('div');
        templates.style.cssText='display:flex;flex-direction:column;gap:6px';
        
        const options=[
          {icon:'📄', label:'New Task'},
          {icon:'📄', label:'Empty'},
          {icon:'＋', label:'New template', color:'#9aa1aa'}
        ];
        
        options.forEach(opt=>{
          const optItem=document.createElement('div');
          optItem.style.cssText=`padding:8px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s;${opt.color?'color:'+opt.color:''}`;
          optItem.innerHTML=`<span style="font-size:16px">${opt.icon}</span><span${opt.label==='New Task'?' style="font-weight:500"':''}>${opt.label}</span>`;
          optItem.onmouseover=()=>optItem.style.background='var(--hover)';
          optItem.onmouseout=()=>optItem.style.background='';
          optItem.onclick=(e)=>{
            e.stopPropagation();
            activateEditor();
          };
          templates.appendChild(optItem);
        });
        
        placeholderSection.appendChild(templates);
        contentArea.appendChild(placeholderSection);
        
        // Click anywhere in the placeholder section to activate editor
        placeholderSection.onclick=()=>{
          activateEditor();
        };
        
        // Function to activate the content editor
        function activateEditor(){
          placeholderSection.remove();
          
          const contentEditor=document.createElement('div');
          contentEditor.contentEditable='true';
          contentEditor.style.cssText='min-height:150px;outline:none;padding:12px 0;line-height:1.6;color:#9aa1aa';
          contentEditor.textContent="Write, press 'space' for AI, '/' for commands...";
          
          // Make it editable immediately
          contentArea.appendChild(contentEditor);
          contentEditor.focus();
          
          // Clear placeholder on first input
          let isFirstInput = true;
          contentEditor.oninput=()=>{
            if(isFirstInput){
              // Remove the placeholder text on first keystroke
              const cursorPos = window.getSelection().focusOffset;
              if(cursorPos <= contentEditor.textContent.length){
                contentEditor.textContent = contentEditor.textContent.replace("Write, press 'space' for AI, '/' for commands...", '');
              }
              contentEditor.style.color='var(--text)';
              isFirstInput = false;
            }
            task.body=contentEditor.textContent.trim();
            save(state);
            renderEditor(scope,pageId);
          };
          
          // Handle focus - select all placeholder text so user can start typing
          contentEditor.onfocus=()=>{
            if(isFirstInput){
              // Select all the placeholder text
              const range = document.createRange();
              range.selectNodeContents(contentEditor);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          };
          
          // If they click away without typing, restore template selection
          contentEditor.onblur=()=>{
            if(isFirstInput && !contentEditor.textContent.trim()){
              contentEditor.remove();
              contentArea.appendChild(placeholderSection);
            }
          };
        }
      }
      
      body.appendChild(contentArea);
      
      sidebar.appendChild(header);
      sidebar.appendChild(body);
      
      document.body.appendChild(backdrop);
      document.body.appendChild(sidebar);

      // Maximize functionality - expands sidebar to full width
      header.querySelector('#maximizeTask').onclick=(e)=>{
        e.stopPropagation();
        
        // Toggle maximize state
        const isMaximized = sidebar.style.width === '100vw';
        
        if(isMaximized){
          // Restore to normal size
          sidebar.style.width = '50vw';
          sidebar.style.maxWidth = '800px';
          sidebar.style.minWidth = '600px';
        } else {
          // Maximize to full width
          sidebar.style.width = '100vw';
          sidebar.style.maxWidth = 'none';
          sidebar.style.minWidth = '0';
        }
      };
      
      // Trigger animation
      requestAnimationFrame(()=>{
        sidebar.classList.add('open');
        backdrop.classList.add('visible');
      });
      
      // Close handlers
      const close=()=>{
        sidebar.classList.remove('open');
        backdrop.style.opacity='0';
        setTimeout(()=>{
          if(sidebar.parentNode) sidebar.remove();
          if(backdrop.parentNode) backdrop.remove();
        },300);
      };
      
      backdrop.onclick=close;
      header.querySelector('#closeTaskDetail').onclick=close;
    }

    // Database entry detail sidebar
    function openDatabaseEntry(entry, parentPage, scope, pageId){
      // Remove existing
      const existing = document.querySelector('.db-entry-sidebar');
      if(existing) existing.remove();
      const existingBackdrop = document.querySelector('.db-entry-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'db-entry-backdrop';
      
      const sidebar = document.createElement('div');
      sidebar.className = 'db-entry-sidebar';
      
      // Header
      const header = document.createElement('div');
      header.className = 'db-entry-header';
      header.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
          <button class="close-btn" id="closeDbEntry">←</button>
          <button class="close-btn" id="maximizeDbEntry">⇱</button>
        </div>
      `;
      
      // Body
      const body = document.createElement('div');
      body.className = 'db-entry-body';
      
      // Entry title
      const titleInput = document.createElement('input');
      titleInput.className = 'db-entry-title';
      titleInput.value = entry.name || '';
      titleInput.placeholder = 'New page';
      titleInput.oninput = () => {
        entry.name = titleInput.value;
        save(state);
        renderEditor(scope, pageId);
      };
      body.appendChild(titleInput);
      
      // Properties
      const propsContainer = document.createElement('div');
      propsContainer.style.marginBottom = '24px';
      
      // Created time
      const createdProp = document.createElement('div');
      createdProp.className = 'db-property';
      createdProp.innerHTML = `
        <div class="db-property-label">
          <span>🕐</span> Created
        </div>
        <div class="db-property-value">
          ${new Date(entry.created || Date.now()).toLocaleString('en-US', {
            month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
          })}
        </div>
      `;
      propsContainer.appendChild(createdProp);
      
      // Tags property
      const tagsProp = document.createElement('div');
      tagsProp.className = 'db-property';
      tagsProp.style.position = 'relative';
      
      const tagLabel = document.createElement('div');
      tagLabel.className = 'db-property-label';
      tagLabel.innerHTML = '<span>≡</span> Tags';
      
      const tagValueContainer = document.createElement('div');
      tagValueContainer.style.cssText = 'flex:1;position:relative';
      
      // Initialize tags property in database if not exists
      if(!parentPage.database.tagOptions){
        parentPage.database.tagOptions = [];
      }
      
      // Initialize entry tags if not exists
      if(!entry.properties.tags){
        entry.properties.tags = [];
      }
      
      const tagDisplay = document.createElement('div');
      tagDisplay.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:32px;cursor:pointer';
      
      // Render selected tags
      const renderTags = () => {
        tagDisplay.innerHTML = '';
        
        if(entry.properties.tags && entry.properties.tags.length > 0){
          entry.properties.tags.forEach(tagId => {
            const tagOption = parentPage.database.tagOptions.find(t => t.id === tagId);
            if(tagOption){
              const pillWrapper = document.createElement('span');
              pillWrapper.style.cssText = 'position:relative;display:inline-block';
              
              const pill = document.createElement('span');
              pill.className = `tag-pill tag-${tagOption.color || 'default'}`;
              pill.style.position = 'relative';
              pill.innerHTML = `
                <span>${tagOption.name}</span>
                <span class="remove">×</span>
              `;
              
              // Tooltip on hover
              const tooltip = document.createElement('div');
              tooltip.style.cssText = `
                position:absolute;
                bottom:calc(100% + 6px);
                left:50%;
                transform:translateX(-50%);
                background:#1f1f1f;
                color:#fff;
                padding:6px 12px;
                border-radius:6px;
                font-size:13px;
                white-space:nowrap;
                opacity:0;
                pointer-events:none;
                transition:opacity .2s;
                z-index:1000;
              `;
              tooltip.textContent = tagOption.name;
              pillWrapper.appendChild(tooltip);
              
              // Show tooltip on hover
              pill.onmouseenter = () => {
                tooltip.style.opacity = '1';
              };
              pill.onmouseleave = () => {
                tooltip.style.opacity = '0';
              };
              
              // Click to open dropdown (for editing)
              pill.onclick = (e) => {
                const removeBtn = e.target.closest('.remove');
                if(removeBtn) return; // Let remove button handle its own click
                
                e.stopPropagation();
                e.preventDefault();
                
                console.log('Tag clicked!', tagOption.name); // Debug log
                
                // Store the current tag option for highlighting
                const currentTagOption = tagOption;
                
                // Remove existing dropdown first
                const existingDropdown = document.querySelector('.tag-dropdown');
                if(existingDropdown) existingDropdown.remove();
                
                // Create dropdown positioned below this tag
                const dropdown = document.createElement('div');
                dropdown.className = 'tag-dropdown';
                dropdown.style.position = 'fixed';
                dropdown.style.zIndex = '10000';
                
                const pillRect = pill.getBoundingClientRect();
                dropdown.style.left = pillRect.left + 'px';
                dropdown.style.top = (pillRect.bottom + 4) + 'px';
                dropdown.style.minWidth = '300px';
                
                // Header
                const header = document.createElement('div');
                header.className = 'tag-dropdown-header';
                header.textContent = 'Select an option or create one';
                dropdown.appendChild(header);
                
                // Show all tags (selected ones grayed out)
                parentPage.database.tagOptions.forEach(tag => {
                  const item = document.createElement('div');
                  item.className = 'tag-dropdown-item';
                  const isSelected = entry.properties.tags.includes(tag.id);
                  if(isSelected) item.style.opacity = '0.6';
                  
                  item.innerHTML = `
                    <span class="drag-handle">⋮⋮</span>
                    <span class="tag-label tag-${tag.color || 'default'}">${tag.name}</span>
                    <span class="more-btn">⋯</span>
                  `;
                  
                  // Click to add/remove tag
                  item.onclick = (ev) => {
                    if(ev.target.classList.contains('more-btn')) return;
                    ev.stopPropagation();
                    if(isSelected){
                      // Remove tag
                      entry.properties.tags = entry.properties.tags.filter(id => id !== tag.id);
                    } else {
                      // Add tag
                      entry.properties.tags.push(tag.id);
                    }
                    save(state);
                    renderTags();
                    renderEditor(scope, pageId);
                    dropdown.remove();
                  };
                  
                  // More button
                  item.querySelector('.more-btn').onclick = (ev) => {
                    ev.stopPropagation();
                    showTagOptions(tag, item, parentPage, entry, scope, pageId, renderTags, dropdown);
                  };
                  
                  // Highlight the clicked tag
                  if(tag.id === currentTagOption.id){
                    item.style.background = '#e0e0e0';
                    setTimeout(() => {
                      if(item.parentNode) item.style.background = '';
                    }, 500);
                  }
                  
                  dropdown.appendChild(item);
                });
                
                document.body.appendChild(dropdown);
                console.log('Dropdown appended to body'); // Debug log
                
                // Close on outside click
                setTimeout(() => {
                  const closeDropdown = (ev) => {
                    if(!dropdown.contains(ev.target) && !pill.contains(ev.target)){
                      dropdown.remove();
                      document.removeEventListener('click', closeDropdown);
                    }
                  };
                  document.addEventListener('click', closeDropdown);
                }, 100);
              };
              
              // Remove button
              pill.querySelector('.remove').onclick = (e) => {
                e.stopPropagation();
                entry.properties.tags = entry.properties.tags.filter(id => id !== tagId);
                save(state);
                renderTags();
                renderEditor(scope, pageId);
              };
              
              pillWrapper.appendChild(pill);
              tagDisplay.appendChild(pillWrapper);
            }
          });
        }
        
        // Add input for new tag
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'tag-input-wrapper';
        inputWrapper.style.cssText = 'position:relative;flex:1;min-width:150px';
        
        const input = document.createElement('input');
        input.placeholder = entry.properties.tags.length > 0 ? '' : 'Empty';
        input.style.cssText = 'border:none;outline:none;background:transparent;width:100%;font-size:14px;color:var(--text)';
        
        inputWrapper.appendChild(input);
        tagDisplay.appendChild(inputWrapper);
        
        // Tag dropdown functionality
        let dropdown;
        
        input.onfocus = () => {
          showTagDropdown();
        };
        
        input.oninput = () => {
          showTagDropdown();
        };
        
        function showTagDropdown(){
          // Remove existing dropdown
          if(dropdown) dropdown.remove();
          
          dropdown = document.createElement('div');
          dropdown.className = 'tag-dropdown';
          
          const searchTerm = input.value.toLowerCase();
          
          // Filter existing tags
          const matchingTags = parentPage.database.tagOptions.filter(tag => 
            tag.name.toLowerCase().includes(searchTerm) &&
            !entry.properties.tags.includes(tag.id)
          );
          
          // Show "Select an option or create one"
          if(matchingTags.length > 0 || searchTerm){
            const header = document.createElement('div');
            header.className = 'tag-dropdown-header';
            header.textContent = 'Select an option or create one';
            dropdown.appendChild(header);
          }
          
          // Create new tag option
          if(searchTerm){
            const existingTag = parentPage.database.tagOptions.find(t => t.name.toLowerCase() === searchTerm);
            
            // Only show "Create" if tag doesn't already exist
            if(!existingTag){
              const createItem = document.createElement('div');
              createItem.className = 'tag-create-item';
              createItem.innerHTML = `
                <span style="font-weight:600">Create</span>
                <span class="tag-label tag-default">${input.value}</span>
              `;
              createItem.onclick = () => {
                const newTag = {
                  id: uid('tag'),
                  name: input.value,
                  color: 'default'
                };
                parentPage.database.tagOptions.push(newTag);
                entry.properties.tags.push(newTag.id);
                save(state);
                input.value = '';
                renderTags();
                renderEditor(scope, pageId);
                dropdown.remove();
              };
              dropdown.appendChild(createItem);
            }
          }
          
          // Show existing tags
          if(searchTerm && matchingTags.length > 0){
            matchingTags.forEach(tag => {
              const item = document.createElement('div');
              item.className = 'tag-dropdown-item';
              item.innerHTML = `
                <span class="drag-handle">⋮⋮</span>
                <span class="tag-label tag-${tag.color || 'default'}">${tag.name}</span>
                <span class="more-btn">⋯</span>
              `;
              
              // Click tag to select
              item.onclick = (e) => {
                if(e.target.classList.contains('more-btn')) return;
                entry.properties.tags.push(tag.id);
                save(state);
                input.value = '';
                renderTags();
                renderEditor(scope, pageId);
                dropdown.remove();
              };
              
              // More button - show tag options
              item.querySelector('.more-btn').onclick = (e) => {
                e.stopPropagation();
                showTagOptions(tag, item, parentPage, entry, scope, pageId, renderTags, dropdown);
              };
              
              dropdown.appendChild(item);
            });
          }
          
          // Show all existing tags if no search (default dropdown)
          if(!searchTerm){
            // Show selected tags first (grayed out, but can be clicked to edit)
            parentPage.database.tagOptions.filter(tag => 
              entry.properties.tags.includes(tag.id)
            ).forEach(tag => {
              const item = document.createElement('div');
              item.className = 'tag-dropdown-item';
              item.style.opacity = '0.6';
              item.innerHTML = `
                <span class="drag-handle">⋮⋮</span>
                <span class="tag-label tag-${tag.color || 'default'}">${tag.name}</span>
                <span class="more-btn">⋯</span>
              `;
              
              // Can't add again (already selected), but show menu on click
              item.onclick = (e) => {
                if(e.target.classList.contains('more-btn')) return;
                e.stopPropagation();
                // Just show the options menu
              };
              
              // More button - show tag options
              item.querySelector('.more-btn').onclick = (e) => {
                e.stopPropagation();
                showTagOptions(tag, item, parentPage, entry, scope, pageId, renderTags, dropdown);
              };
              
              dropdown.appendChild(item);
            });
            
            // Then show unselected tags
            parentPage.database.tagOptions.filter(tag => 
              !entry.properties.tags.includes(tag.id)
            ).forEach(tag => {
              const item = document.createElement('div');
              item.className = 'tag-dropdown-item';
              item.innerHTML = `
                <span class="drag-handle">⋮⋮</span>
                <span class="tag-label tag-${tag.color || 'default'}">${tag.name}</span>
                <span class="more-btn">⋯</span>
              `;
              
              item.onclick = (e) => {
                if(e.target.classList.contains('more-btn')) return;
                entry.properties.tags.push(tag.id);
                save(state);
                input.value = '';
                renderTags();
                renderEditor(scope, pageId);
                dropdown.remove();
              };
              
              item.querySelector('.more-btn').onclick = (e) => {
                e.stopPropagation();
                showTagOptions(tag, item, parentPage, entry, scope, pageId, renderTags, dropdown);
              };
              
              dropdown.appendChild(item);
            });
          }
          
          inputWrapper.appendChild(dropdown);
        }
        
        // Close dropdown on outside click
        document.addEventListener('click', function closeDropdown(e){
          if(dropdown && !inputWrapper.contains(e.target)){
            dropdown.remove();
            dropdown = null;
            document.removeEventListener('click', closeDropdown);
          }
        });
      };
      
      renderTags();
      
      tagsProp.appendChild(tagLabel);
      tagsProp.appendChild(tagValueContainer);
      tagValueContainer.appendChild(tagDisplay);
      propsContainer.appendChild(tagsProp);

      // Render other custom properties
      if(parentPage.database.properties){
        parentPage.database.properties.forEach(prop => {
          // Skip default properties (created, tags)
          if(prop.type === 'created_time' || prop.id === 'tags') return;
          
          // Render Select and Multi-select properties
          if(prop.type === 'select' || prop.type === 'multi_select'){
            const selectProp = document.createElement('div');
            selectProp.className = 'db-property';
            selectProp.style.position = 'relative';
            
            const selectLabel = document.createElement('div');
            selectLabel.className = 'db-property-label';
            selectLabel.innerHTML = `<span>⊙</span> ${prop.name}`;
            selectLabel.style.cursor = 'pointer';
            
            // Click label to open property configuration
            selectLabel.onclick = (e) => {
              e.stopPropagation();
              openPropertyConfigPanel(selectLabel, prop, parentPage, entry, scope, pageId);
            };
            
            const selectValueContainer = document.createElement('div');
            selectValueContainer.style.cssText = 'flex:1;position:relative';
            
            const selectDisplay = document.createElement('div');
            selectDisplay.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:32px;cursor:pointer';
            
            // Render selected values
            const renderSelectValue = () => {
              selectDisplay.innerHTML = '';
              
              const currentValue = entry.properties[prop.id];
              
              if(prop.type === 'multi_select' && currentValue && currentValue.length > 0){
                // Multi-select: show multiple pills
                currentValue.forEach(optId => {
                  const option = prop.options.find(o => o.id === optId);
                  if(option){
                    const pill = document.createElement('span');
                    pill.className = `property-select-pill tag-${option.color || 'default'}`;
                    pill.innerHTML = `
                      <span>${option.name}</span>
                      <span class="remove" style="font-size:14px;opacity:0.6;cursor:pointer;margin-left:4px">×</span>
                    `;
                    
                    // Remove option
                    pill.querySelector('.remove').onclick = (e) => {
                      e.stopPropagation();
                      entry.properties[prop.id] = entry.properties[prop.id].filter(id => id !== optId);
                      save(state);
                      renderSelectValue();
                      renderEditor(scope, pageId);
                    };
                    
                    selectDisplay.appendChild(pill);
                  }
                });
                
                // Add input for more
                const addMore = document.createElement('span');
                addMore.textContent = 'Empty';
                addMore.style.cssText = 'color:#9aa1aa;font-size:14px;cursor:pointer;opacity:0';
                selectDisplay.appendChild(addMore);
              } else if(prop.type === 'select' && currentValue){
                // Single select: show one pill
                const option = prop.options.find(o => o.id === currentValue);
                if(option){
                  const pill = document.createElement('span');
                  pill.className = `property-select-pill tag-${option.color || 'default'}`;
                  pill.innerHTML = `
                    <span>${option.name}</span>
                    <span class="remove" style="font-size:14px;opacity:0.6;cursor:pointer;margin-left:4px">×</span>
                  `;
                  
                  // Remove option
                  pill.querySelector('.remove').onclick = (e) => {
                    e.stopPropagation();
                    entry.properties[prop.id] = null;
                    save(state);
                    renderSelectValue();
                    renderEditor(scope, pageId);
                  };
                  
                  selectDisplay.appendChild(pill);
                }
              } else {
                // Empty state
                const empty = document.createElement('span');
                empty.textContent = 'Empty';
                empty.style.cssText = 'color:#9aa1aa;font-size:14px';
                selectDisplay.appendChild(empty);
              }
            };
            
            renderSelectValue();
            
            // Click to open dropdown
            selectDisplay.onclick = (e) => {
              e.stopPropagation();
              openSelectDropdown(selectDisplay, prop, entry, parentPage, scope, pageId, renderSelectValue);
            };
            
            selectValueContainer.appendChild(selectDisplay);
            selectProp.appendChild(selectLabel);
            selectProp.appendChild(selectValueContainer);
            propsContainer.appendChild(selectProp);
          }
        });
      }
      
      // Add property button
      const addProp = document.createElement('div');
      addProp.className = 'add-property-btn';
      addProp.innerHTML = '<span>＋</span> Add a property';
      addProp.onclick = (e) => {
        e.stopPropagation();
        openPropertyTypeSelector(addProp, parentPage, entry, scope, pageId);
      };
      propsContainer.appendChild(addProp);
      
      body.appendChild(propsContainer);
      
      // Comments
      const comments = document.createElement('div');
      comments.className = 'db-comments-section';
      comments.innerHTML = `
        <h4>Comments</h4>
        <div style="display:flex;align-items:center;gap:12px;color:#9aa1aa;font-size:14px;padding:12px;background:var(--panel-2);border-radius:8px;cursor:pointer">
          <span style="font-size:20px">👤</span>
          <span>Add a comment...</span>
        </div>
      `;
      body.appendChild(comments);
      
      // Content area
      const contentArea = document.createElement('div');
      contentArea.style.marginTop = '24px';
      contentArea.style.paddingTop = '24px';
      contentArea.style.borderTop = '1px solid var(--border)';
      
      const contentEditor = document.createElement('div');
      contentEditor.contentEditable = 'true';
      contentEditor.style.cssText = 'min-height:200px;outline:none;padding:12px 0;line-height:1.6;color:var(--text)';
      contentEditor.dataset.placeholder = "Write, press 'space' for AI, '/' for commands...";
      
      // Initialize with existing content or placeholder
      if(entry.body && entry.body.trim()){
        contentEditor.textContent = entry.body;
        contentEditor.classList.remove('editor-placeholder');
      } else {
        contentEditor.textContent = contentEditor.dataset.placeholder;
        contentEditor.classList.add('editor-placeholder');
        contentEditor.style.color = '#9aa1aa';
      }
      
      // Handle focus - clear placeholder
      contentEditor.onfocus = () => {
        if(!entry.body || !entry.body.trim()){
          contentEditor.textContent = '';
          contentEditor.classList.remove('editor-placeholder');
          contentEditor.style.color = 'var(--text)';
        }
      };
      
      // Handle blur - restore placeholder if empty
      contentEditor.onblur = () => {
        if(!contentEditor.textContent.trim()){
          contentEditor.textContent = contentEditor.dataset.placeholder;
          contentEditor.classList.add('editor-placeholder');
          contentEditor.style.color = '#9aa1aa';
        }
      };
      
      // Handle input - save content
      contentEditor.oninput = () => {
        if(contentEditor.classList.contains('editor-placeholder')) return;
        entry.body = contentEditor.textContent;
        save(state);
        renderEditor(scope, pageId);
      };
      
      contentArea.appendChild(contentEditor);
      body.appendChild(contentArea);
      
      sidebar.appendChild(header);
      sidebar.appendChild(body);
      
      document.body.appendChild(backdrop);
      document.body.appendChild(sidebar);
      
      // Trigger animation
      const existingOpen = document.querySelector('.db-entry-sidebar.open');
      if(!existingOpen){
        requestAnimationFrame(() => {
          sidebar.classList.add('open');
          backdrop.classList.add('visible');
        });
      } else {
        // Already open, no animation needed
        sidebar.classList.add('open');
        backdrop.classList.add('visible');
      }
      
      // Close handlers
      const close = () => {
        sidebar.classList.remove('open');
        backdrop.style.opacity = '0';
        setTimeout(() => {
          if(sidebar.parentNode) sidebar.remove();
          if(backdrop.parentNode) backdrop.remove();
        }, 300);
      };
      
      backdrop.onclick = close;
      header.querySelector('#closeDbEntry').onclick = close;
      
      // Maximize handler
      header.querySelector('#maximizeDbEntry').onclick = () => {
        const isMaximized = sidebar.style.width === '100vw';
        if(isMaximized){
          sidebar.style.width = '50vw';
          sidebar.style.maxWidth = '800px';
          sidebar.style.minWidth = '600px';
        } else {
          sidebar.style.width = '100vw';
          sidebar.style.maxWidth = 'none';
          sidebar.style.minWidth = '0';
        }
      };
      
      // Focus title
      titleInput.focus();
    }

    // Show tag options menu (rename, delete, change color)
    function showTagOptions(tag, parentItem, parentPage, entry, scope, pageId, renderCallback, dropdown){
      // Remove existing menu
      const existingMenu = document.querySelector('.tag-options-menu');
      if(existingMenu) existingMenu.remove();
      
      const menu = document.createElement('div');
      menu.className = 'tag-options-menu';
      
      // Rename input
      const renameInput = document.createElement('input');
      renameInput.className = 'tag-rename-input';
      renameInput.value = tag.name;
      renameInput.onclick = (e) => e.stopPropagation();
      renameInput.oninput = () => {
        tag.name = renameInput.value;
        save(state);
        renderCallback();
        renderEditor(scope, pageId);
      };
      menu.appendChild(renameInput);
      
      // Delete button
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'tag-menu-item';
      deleteBtn.innerHTML = '<span>🗑️</span><span>Delete</span>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        // Remove tag from all entries
        parentPage.database.entries.forEach(e => {
          if(e.properties.tags){
            e.properties.tags = e.properties.tags.filter(id => id !== tag.id);
          }
        });
        // Remove from tag options
        parentPage.database.tagOptions = parentPage.database.tagOptions.filter(t => t.id !== tag.id);
        save(state);
        renderCallback();
        renderEditor(scope, pageId);
        menu.remove();
        if(dropdown) dropdown.remove();
      };
      menu.appendChild(deleteBtn);
      
      // Divider
      const divider = document.createElement('div');
      divider.className = 'tag-menu-divider';
      menu.appendChild(divider);
      
      // Colors section
      const colorsLabel = document.createElement('div');
      colorsLabel.style.cssText = 'color:#9aa1aa;font-size:13px;padding:8px 12px;font-weight:600;margin-bottom:4px';
      colorsLabel.textContent = 'Colors';
      menu.appendChild(colorsLabel);
      
      const colors = [
        {name:'Default', value:'default', bg:'#e5e7eb'},
        {name:'Gray', value:'gray', bg:'#e5e7eb'},
        {name:'Brown', value:'brown', bg:'#e0d4c8'},
        {name:'Orange', value:'orange', bg:'#fed7aa'},
        {name:'Yellow', value:'yellow', bg:'#fef3c7'},
        {name:'Green', value:'green', bg:'#d1fae5'},
        {name:'Blue', value:'blue', bg:'#dbeafe'},
        {name:'Purple', value:'purple', bg:'#e9d5ff'},
        {name:'Pink', value:'pink', bg:'#fce7f3'},
        {name:'Red', value:'red', bg:'#fee2e2'}
      ];
      
      colors.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.className = 'tag-color-option';
        colorOption.innerHTML = `
          <div class="tag-color-swatch" style="background:${color.bg}"></div>
          <span>${color.name}</span>
          ${tag.color === color.value ? '<span class="checkmark">✓</span>' : ''}
        `;
        colorOption.onclick = (e) => {
          e.stopPropagation();
          tag.color = color.value;
          save(state);
          renderCallback();
          renderEditor(scope, pageId);
          menu.remove();
        };
        menu.appendChild(colorOption);
      });
      
      // Position menu next to the parent item
      document.body.appendChild(menu);
      
      const dropdownRect = dropdown ? dropdown.getBoundingClientRect() : parentItem.getBoundingClientRect();
      const itemRect = parentItem.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();
      
      menu.style.position = 'fixed';
      
      // Align top with dropdown top
      menu.style.top = dropdownRect.top + 'px';
      
      // Position to the right of the dropdown
      menu.style.left = (dropdownRect.right + 8) + 'px';
      
      // Check if menu goes off screen horizontally
      if(menuRect.right > window.innerWidth || (dropdownRect.right + menuRect.width + 8) > window.innerWidth){
        // Position to the left of dropdown instead
        menu.style.left = (dropdownRect.left - menuRect.width - 8) + 'px';
      }
      
      // Check if menu goes off screen vertically
      const updatedMenuRect = menu.getBoundingClientRect();
      if(updatedMenuRect.bottom > window.innerHeight){
        // Adjust to fit on screen
        menu.style.top = (window.innerHeight - menuRect.height - 20) + 'px';
      }
      
      // Close on outside click
      setTimeout(() => {
        const closeMenu = (e) => {
          if(!menu.contains(e.target) && !parentItem.contains(e.target)){
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        };
        document.addEventListener('click', closeMenu);
      }, 100);
      
      // Focus rename input
      renameInput.focus();
      renameInput.select();
    }

    // Open sort dropdown
    function openSortDropdown(btnElement, page, scope, pageId){
      // Remove existing
      const existing = document.querySelector('.sort-dropdown');
      if(existing) existing.remove();
      const existingBackdrop = document.querySelector('.sort-dropdown-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'sort-dropdown-backdrop';
      
      const dropdown = document.createElement('div');
      dropdown.className = 'sort-dropdown';
      
      // Search input
      const search = document.createElement('input');
      search.className = 'sort-search';
      search.placeholder = 'Sort by...';
      search.onclick = (e) => e.stopPropagation();
      dropdown.appendChild(search);
      
      // Get current sort setting
      if(!page.database.sort){
        page.database.sort = {field: null, direction: 'asc'};
      }
      
      const sortOptions = [
        {icon: 'Aa', label: 'Name', field: 'name'},
        {icon: '🕐', label: 'Created', field: 'created'},
        {icon: '≡', label: 'Tags', field: 'tags'}
      ];
      
      const optionsContainer = document.createElement('div');
      
      sortOptions.forEach(option => {
        const item = document.createElement('div');
        item.className = 'sort-option';
        if(page.database.sort.field === option.field){
          item.classList.add('active');
        }
        
        item.innerHTML = `
          <span class="icon">${option.icon}</span>
          <span class="label">${option.label}</span>
        `;
        
        item.onclick = () => {
          // Toggle or set sort
          if(page.database.sort.field === option.field){
            // Toggle direction
            page.database.sort.direction = page.database.sort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            // Set new field
            page.database.sort.field = option.field;
            page.database.sort.direction = 'asc';
          }
          
          // Sort the entries
          sortEntries(page.database.entries, option.field, page.database.sort.direction, page);
          
          save(state);
          renderEditor(scope, pageId);
          close();
        };
        
        optionsContainer.appendChild(item);
      });
      
      dropdown.appendChild(optionsContainer);
      
      // Position below the button
      const btnRect = btnElement.getBoundingClientRect();
      dropdown.style.left = (btnRect.left - 100) + 'px';
      dropdown.style.top = (btnRect.bottom + 8) + 'px';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(dropdown);
      
      // Search filter
      search.oninput = () => {
        const query = search.value.toLowerCase();
        optionsContainer.querySelectorAll('.sort-option').forEach(opt => {
          const label = opt.querySelector('.label').textContent.toLowerCase();
          opt.style.display = label.includes(query) ? 'flex' : 'none';
        });
      };
      
      // Close function
      const close = () => {
        if(backdrop.parentNode) backdrop.remove();
        if(dropdown.parentNode) dropdown.remove();
      };
      
      backdrop.onclick = close;
      
      // Focus search
      search.focus();
    }

    // Open sort management dropdown (from clicking the sort chip)
    function openSortManageDropdown(chipElement, page, scope, pageId){
      // Remove existing
      const existing = document.querySelector('.sort-manage-dropdown');
      if(existing) existing.remove();
      const existingBackdrop = document.querySelector('.sort-dropdown-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'sort-dropdown-backdrop';
      
      const dropdown = document.createElement('div');
      dropdown.className = 'sort-manage-dropdown';
      
      // Header with field and direction selectors
      const headerDiv = document.createElement('div');
      headerDiv.className = 'sort-manage-header';
      
      const dragIcon = document.createElement('span');
      dragIcon.className = 'drag-icon';
      dragIcon.textContent = '⋮⋮';
      
      // Field selector
      const fieldSelect = document.createElement('div');
      fieldSelect.className = 'sort-field-select';
      const sortFieldLabels = {
        'name': 'Name',
        'created': 'Created',
        'tags': 'Tags'
      };
      fieldSelect.textContent = `Aa  ${sortFieldLabels[page.database.sort.field] || 'Name'} ⌄`;
      fieldSelect.onclick = (e) => {
        e.stopPropagation();
        // Show field options
        openSortDropdown(fieldSelect, page, scope, pageId);
        close();
      };
      
      // Direction selector
      const directionSelect = document.createElement('div');
      directionSelect.className = 'sort-direction-select';
      directionSelect.textContent = page.database.sort.direction === 'asc' ? 'Ascending ⌄' : 'Descending ⌄';
      directionSelect.onclick = (e) => {
        e.stopPropagation();
        // Toggle direction
        page.database.sort.direction = page.database.sort.direction === 'asc' ? 'desc' : 'asc';
        sortEntries(page.database.entries, page.database.sort.field, page.database.sort.direction, page);
        save(state);
        renderEditor(scope, pageId);
        close();
      };
      
      // Close button
      const closeIcon = document.createElement('span');
      closeIcon.className = 'close-icon';
      closeIcon.textContent = '×';
      closeIcon.onclick = (e) => {
        e.stopPropagation();
        close();
      };
      
      headerDiv.appendChild(dragIcon);
      headerDiv.appendChild(fieldSelect);
      headerDiv.appendChild(directionSelect);
      headerDiv.appendChild(closeIcon);
      dropdown.appendChild(headerDiv);
      
      // Actions
      const actions = document.createElement('div');
      actions.className = 'sort-manage-actions';
      
      const addSort = document.createElement('div');
      addSort.className = 'sort-manage-action';
      addSort.innerHTML = '<span class="icon">＋</span><span>Add sort</span>';
      addSort.onclick = () => {
        // For now, just alert (multi-sort can be added later)
        alert('Multi-sort coming soon!');
      };
      
      const deleteSort = document.createElement('div');
      deleteSort.className = 'sort-manage-action';
      deleteSort.innerHTML = '<span class="icon">🗑</span><span>Delete sort</span>';
      deleteSort.onclick = () => {
        page.database.sort = {field: null, direction: 'asc'};
        save(state);
        renderEditor(scope, pageId);
        close();
      };
      
      actions.appendChild(addSort);
      actions.appendChild(deleteSort);
      dropdown.appendChild(actions);
      
      // Position below the chip
      const chipRect = chipElement.getBoundingClientRect();
      dropdown.style.left = chipRect.left + 'px';
      dropdown.style.top = (chipRect.bottom + 8) + 'px';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(dropdown);
      
      // Close function
      const close = () => {
        if(backdrop.parentNode) backdrop.remove();
        if(dropdown.parentNode) dropdown.remove();
      };
      
      backdrop.onclick = close;
    }

    // Open filter dropdown
    function openFilterDropdown(btnElement, page, scope, pageId){
      // Remove existing
      const existing = document.querySelector('.filter-dropdown');
      if(existing) existing.remove();
      const existingBackdrop = document.querySelector('.sort-dropdown-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'sort-dropdown-backdrop';
      
      const dropdown = document.createElement('div');
      dropdown.className = 'filter-dropdown';
      
      // Search input
      const search = document.createElement('input');
      search.className = 'filter-search';
      search.placeholder = 'Filter by...';
      search.onclick = (e) => e.stopPropagation();
      dropdown.appendChild(search);
      
      // Filter options container
      const optionsContainer = document.createElement('div');
      
      const filterOptions = [
        {icon: 'Aa', label: 'Name', field: 'name'},
        {icon: '🕐', label: 'Created', field: 'created'},
        {icon: '≡', label: 'Tags', field: 'tags'}
      ];
      
      filterOptions.forEach(option => {
        const item = document.createElement('div');
        item.className = 'filter-option';
        
        item.innerHTML = `
          <span class="icon">${option.icon}</span>
          <span class="label">${option.label}</span>
        `;
        
        item.onclick = () => {
          // For now, just alert (filter implementation can be added later)
          alert(`Filter by ${option.label} (coming soon)`);
          close();
        };
        
        optionsContainer.appendChild(item);
      });
      
      dropdown.appendChild(optionsContainer);
      
      // Divider
      const divider = document.createElement('div');
      divider.className = 'filter-divider';
      dropdown.appendChild(divider);
      
      // Advanced filter option
      const advancedOption = document.createElement('div');
      advancedOption.className = 'filter-advanced';
      advancedOption.innerHTML = '<span class="icon">＋</span><span>Add advanced filter</span>';
      advancedOption.onclick = () => {
        alert('Advanced filter (coming soon)');
        close();
      };
      dropdown.appendChild(advancedOption);
      
      // Position below the button
      const btnRect = btnElement.getBoundingClientRect();
      dropdown.style.left = btnRect.left + 'px';
      dropdown.style.top = (btnRect.bottom + 8) + 'px';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(dropdown);
      
      // Search filter
      search.oninput = () => {
        const query = search.value.toLowerCase();
        optionsContainer.querySelectorAll('.filter-option').forEach(opt => {
          const label = opt.querySelector('.label').textContent.toLowerCase();
          opt.style.display = label.includes(query) ? 'flex' : 'none';
        });
      };
      
      // Close function
      const close = () => {
        if(backdrop.parentNode) backdrop.remove();
        if(dropdown.parentNode) dropdown.remove();
      };
      
      backdrop.onclick = close;
      
      // Focus search
      search.focus();
    }
    
    // Sort entries helper function
    function sortEntries(entries, field, direction, page){
      entries.sort((a, b) => {
        let valA, valB;
        
        if(field === 'name'){
          valA = (a.name || '').toLowerCase();
          valB = (b.name || '').toLowerCase();
        } else if(field === 'created'){
          valA = new Date(a.created || 0).getTime();
          valB = new Date(b.created || 0).getTime();
        } else if(field === 'tags'){
          // Sort by number of tags, then by first tag name
          const tagsA = a.properties.tags || [];
          const tagsB = b.properties.tags || [];
          
          if(tagsA.length !== tagsB.length){
            valA = tagsA.length;
            valB = tagsB.length;
          } else if(tagsA.length > 0 && tagsB.length > 0){
            // Sort by first tag name
            const tagOptA = page.database.tagOptions.find(t => t.id === tagsA[0]);
            const tagOptB = page.database.tagOptions.find(t => t.id === tagsB[0]);
            valA = (tagOptA?.name || '').toLowerCase();
            valB = (tagOptB?.name || '').toLowerCase();
          } else {
            return 0;
          }
        }
        
        if(valA < valB) return direction === 'asc' ? -1 : 1;
        if(valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    // Open property type selector (PDF page 5)
    function openPropertyTypeSelector(btnElement, parentPage, entry, scope, pageId){
      // Remove existing
      const existing = document.querySelector('.property-type-selector');
      if(existing) existing.remove();
      const existingBackdrop = document.querySelector('.sort-dropdown-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'sort-dropdown-backdrop';
      
      const selector = document.createElement('div');
      selector.className = 'property-type-selector';
      
      // Property name input
      const nameInput = document.createElement('input');
      nameInput.className = 'property-name-input';
      nameInput.placeholder = 'Property name';
      nameInput.onclick = (e) => e.stopPropagation();
      selector.appendChild(nameInput);
      
      // Type label
      const typeLabel = document.createElement('div');
      typeLabel.className = 'property-type-label';
      typeLabel.innerHTML = '<span>🔍</span> Type';
      selector.appendChild(typeLabel);
      
      // Property types
      const propertyTypes = [
        {icon:'≡', label:'Text', type:'text'},
        {icon:'#', label:'Number', type:'number'},
        {icon:'⊙', label:'Select', type:'select'},
        {icon:'≡', label:'Multi-select', type:'multi_select'},
        {icon:'◉', label:'Status', type:'status'},
        {icon:'📅', label:'Date', type:'date'},
        {icon:'👤', label:'Person', type:'person'},
        {icon:'📎', label:'Files & media', type:'files'},
        {icon:'☑', label:'Checkbox', type:'checkbox'},
        {icon:'🔗', label:'URL', type:'url'},
        {icon:'@', label:'Email', type:'email'},
        {icon:'📞', label:'Phone', type:'phone'},
        {icon:'Σ', label:'Formula', type:'formula'},
        {icon:'↗', label:'Relation', type:'relation'},
        {icon:'🔄', label:'Rollup', type:'rollup'},
        {icon:'🕐', label:'Created time', type:'created_time'},
        {icon:'👤', label:'Created by', type:'created_by'}
      ];
      
      propertyTypes.forEach(propType => {
        const option = document.createElement('div');
        option.className = 'property-type-option';
        option.innerHTML = `
          <span class="icon">${propType.icon}</span>
          <span class="label">${propType.label}</span>
        `;
        
        option.onclick = () => {
          const propName = nameInput.value.trim() || propType.label;
          
          // Create new property
          const newProp = {
            id: uid('prop'),
            name: propName,
            type: propType.type
          };
          
          // Initialize options array for select types
          if(propType.type === 'select' || propType.type === 'multi_select'){
            newProp.options = [];
          }
          
          // Add to database properties
          if(!parentPage.database.properties){
            parentPage.database.properties = [];
          }
          parentPage.database.properties.push(newProp);
          
          // Initialize property value for this entry
          if(!entry.properties) entry.properties = {};
          entry.properties[newProp.id] = propType.type === 'multi_select' ? [] : null;
          
          save(state);
          close();
          
          // If it's a select type, open configuration panel
          if(propType.type === 'select' || propType.type === 'multi_select'){
            setTimeout(() => {
              openPropertyConfigPanel(btnElement, newProp, parentPage, entry, scope, pageId);
            }, 100);
          } else {
            // Just re-render to show the new property
            renderEditor(scope, pageId);
            setTimeout(() => {
              openDatabaseEntry(entry, parentPage, scope, pageId);
            }, 100);
          }
        };
        
        selector.appendChild(option);
      });
      
      // Position below button
      const btnRect = btnElement.getBoundingClientRect();
      selector.style.left = btnRect.left + 'px';
      selector.style.top = (btnRect.bottom + 8) + 'px';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(selector);
      
      // Close function
      const close = () => {
        if(backdrop.parentNode) backdrop.remove();
        if(selector.parentNode) selector.remove();
      };
      
      backdrop.onclick = close;
      
      // Focus name input
      nameInput.focus();
    }
    
    // Open property configuration panel (PDF page 4)
    function openPropertyConfigPanel(btnElement, property, parentPage, entry, scope, pageId){
      // Remove existing
      const existing = document.querySelector('.property-config-panel');
      if(existing) existing.remove();
      const existingBackdrop = document.querySelector('.sort-dropdown-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'sort-dropdown-backdrop';
      
      const panel = document.createElement('div');
      panel.className = 'property-config-panel';
      
      // Header with icon and name
      const header = document.createElement('div');
      header.className = 'property-config-header';
      
      const icon = document.createElement('span');
      icon.className = 'property-config-icon';
      icon.textContent = '⊙';
      
      const nameInput = document.createElement('input');
      nameInput.className = 'property-config-name';
      nameInput.value = property.name;
      nameInput.onclick = (e) => e.stopPropagation();
      nameInput.oninput = () => {
        property.name = nameInput.value;
        save(state);
      };
      
      header.appendChild(icon);
      header.appendChild(nameInput);
      panel.appendChild(header);
      
      // Type option
      const typeItem = document.createElement('div');
      typeItem.className = 'property-config-item';
      typeItem.innerHTML = `
        <span class="icon">🔄</span>
        <span class="label">Type</span>
        <span class="value">${property.type === 'multi_select' ? 'Multi-select' : 'Select'}</span>
        <span class="chevron">›</span>
      `;
      panel.appendChild(typeItem);
      
      // Sort option
      const sortItem = document.createElement('div');
      sortItem.className = 'property-config-item';
      sortItem.innerHTML = `
        <span class="icon">↕</span>
        <span class="label">Sort</span>
        <span class="value">Manual</span>
        <span class="chevron">›</span>
      `;
      panel.appendChild(sortItem);
      
      // AI autofill option
      const aiItem = document.createElement('div');
      aiItem.className = 'property-config-item';
      aiItem.innerHTML = `
        <span class="label">AI autofill</span>
        <label style="position:relative;display:inline-block;width:44px;height:24px">
          <input type="checkbox" style="opacity:0;width:0;height:0">
          <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e0e0e0;border-radius:24px;transition:.3s"></span>
          <span style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.3s"></span>
        </label>
      `;
      panel.appendChild(aiItem);
      
      // Divider
      const divider1 = document.createElement('div');
      divider1.className = 'property-config-divider';
      panel.appendChild(divider1);
      
      // Options section
      const optionsSection = document.createElement('div');
      optionsSection.className = 'property-config-section';
      
      const optionsTitle = document.createElement('div');
      optionsTitle.className = 'property-config-section-title';
      optionsTitle.textContent = 'Options';
      optionsSection.appendChild(optionsTitle);
      
      // Render existing options
      const renderOptions = () => {
        // Remove old option items
        optionsSection.querySelectorAll('.property-option-item').forEach(el => el.remove());
        optionsSection.querySelector('.property-add-option')?.remove();
        
        property.options.forEach((option, index) => {
          const optionItem = document.createElement('div');
          optionItem.className = 'property-option-item';
          optionItem.innerHTML = `
            <span class="drag-handle">⋮⋮</span>
            <span class="option-label tag-${option.color || 'default'}">${option.name}</span>
            <span class="chevron">›</span>
          `;
          
          // Click to edit option
          optionItem.onclick = () => {
            // Open tag options menu for editing
            showPropertyOptionMenu(option, optionItem, property, parentPage, entry, scope, pageId, renderOptions, panel);
          };
          
          optionsSection.appendChild(optionItem);
        });
        
        // Add option button
        const addOption = document.createElement('div');
        addOption.className = 'property-add-option';
        addOption.innerHTML = '<span>＋</span> Add an option';
        addOption.onclick = (e) => {
          e.stopPropagation();
          openOptionInputOverlay(addOption, property, parentPage, entry, scope, pageId, renderOptions);
        };
        optionsSection.appendChild(addOption);
      };
      
      renderOptions();
      panel.appendChild(optionsSection);
      
      // Divider
      const divider2 = document.createElement('div');
      divider2.className = 'property-config-divider';
      panel.appendChild(divider2);
      
      // Duplicate property
      const duplicateItem = document.createElement('div');
      duplicateItem.className = 'property-config-item';
      duplicateItem.innerHTML = '<span class="icon">📄</span><span class="label">Duplicate property</span>';
      duplicateItem.onclick = () => {
        const newProp = {...property, id: uid('prop'), name: property.name + ' (copy)', options: property.options ? property.options.map(o => ({...o})) : []};
        parentPage.database.properties.push(newProp);
        save(state);
        close();
        renderEditor(scope, pageId);
        setTimeout(() => {
          openDatabaseEntry(entry, parentPage, scope, pageId);
        }, 10);
      };
      panel.appendChild(duplicateItem);
      
      // Delete property
      const deleteItem = document.createElement('div');
      deleteItem.className = 'property-config-item';
      deleteItem.innerHTML = '<span class="icon">🗑</span><span class="label">Delete property</span>';
      deleteItem.onclick = () => {
        parentPage.database.properties = parentPage.database.properties.filter(p => p.id !== property.id);
        parentPage.database.entries.forEach(e => {
          if(e.properties) delete e.properties[property.id];
        });
        save(state);
        close();
        renderEditor(scope, pageId);
        setTimeout(() => {
          openDatabaseEntry(entry, parentPage, scope, pageId);
        }, 10);
      };
      panel.appendChild(deleteItem);
      
      // Position
      const btnRect = btnElement.getBoundingClientRect();
      panel.style.left = btnRect.left + 'px';
      panel.style.top = (btnRect.bottom + 8) + 'px';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(panel);
      
      // Close function
      const close = () => {
        if(backdrop.parentNode) backdrop.remove();
        if(panel.parentNode) panel.remove();
      };
      
      backdrop.onclick = close;
      
      // Focus name input
      nameInput.focus();
      nameInput.select();
    }
    
    // Open option input overlay (PDF page 3)
    function openOptionInputOverlay(btnElement, property, parentPage, entry, scope, pageId, refreshCallback){
      // Remove existing
      const existing = document.querySelector('.option-input-overlay');
      if(existing) existing.remove();
      
      const overlay = document.createElement('div');
      overlay.className = 'option-input-overlay';
      
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = 'Options';
      overlay.appendChild(title);
      
      const input = document.createElement('input');
      input.className = 'option-input-field';
      input.placeholder = 'Type a new option...';
      input.onclick = (e) => e.stopPropagation();
      overlay.appendChild(input);
      
      // Handle Enter key to add option
      input.onkeydown = (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          const optionName = input.value.trim();
          if(optionName){
            // Initialize options array if it doesn't exist
            if(!property.options){
              property.options = [];
            }
            
            const newOption = {
              id: uid('opt'),
              name: optionName,
              color: 'default'
            };
            property.options.push(newOption);
            save(state);
            input.value = '';
            
            // Refresh the config panel to show the new option
            refreshCallback();
            renderEditor(scope, pageId);
            setTimeout(() => {
              openDatabaseEntry(entry, parentPage, scope, pageId);
            }, 10);
          }
        } else if(e.key === 'Escape'){
          overlay.remove();
        }
      };
      
      const actions = document.createElement('div');
      actions.className = 'option-input-actions';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => {
        overlay.remove();
      };
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save';
      saveBtn.textContent = 'Done';
      saveBtn.onclick = () => {
        const optionName = input.value.trim();
        if(optionName){
          // Initialize options array if it doesn't exist
          if(!property.options){
            property.options = [];
          }
          
          const newOption = {
            id: uid('opt'),
            name: optionName,
            color: 'default'
          };
          property.options.push(newOption);
          save(state);
          
          // Refresh both the config panel and entry sidebar
          refreshCallback();
          renderEditor(scope, pageId);
          setTimeout(() => {
            openDatabaseEntry(entry, parentPage, scope, pageId);
          }, 10);
        }
        overlay.remove();
      };

      actions.appendChild(cancelBtn);
      actions.appendChild(saveBtn);
      overlay.appendChild(actions);
      
      // Position below button
      const btnRect = btnElement.getBoundingClientRect();
      overlay.style.left = btnRect.left + 'px';
      overlay.style.top = (btnRect.bottom + 8) + 'px';
      
      document.body.appendChild(overlay);
      
      // Focus input
      input.focus();
      
      // Close on outside click
      setTimeout(() => {
        const closeOverlay = (e) => {
          if(!overlay.contains(e.target) && !btnElement.contains(e.target)){
            overlay.remove();
            document.removeEventListener('click', closeOverlay);
          }
        };
        document.addEventListener('click', closeOverlay);
      }, 100);
    }
    
    // Show property option menu (for editing colors, deleting)
    function showPropertyOptionMenu(option, parentItem, property, parentPage, entry, scope, pageId, refreshCallback, configPanel){
      // Remove existing menu
      const existingMenu = document.querySelector('.tag-options-menu');
      if(existingMenu) existingMenu.remove();
      
      const menu = document.createElement('div');
      menu.className = 'tag-options-menu';
      
      // Rename input
      const renameInput = document.createElement('input');
      renameInput.className = 'tag-rename-input';
      renameInput.value = option.name;
      renameInput.onclick = (e) => e.stopPropagation();
      renameInput.oninput = () => {
        option.name = renameInput.value;
        save(state);
        refreshCallback();
      };
      menu.appendChild(renameInput);
      
      // Delete button
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'tag-menu-item';
      deleteBtn.innerHTML = '<span>🗑️</span><span>Delete</span>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        property.options = property.options.filter(o => o.id !== option.id);
        // Remove from all entries
        parentPage.database.entries.forEach(e => {
          if(e.properties[property.id]){
            if(Array.isArray(e.properties[property.id])){
              e.properties[property.id] = e.properties[property.id].filter(id => id !== option.id);
            } else if(e.properties[property.id] === option.id){
              e.properties[property.id] = null;
            }
          }
        });
        save(state);
        refreshCallback();
        renderEditor(scope, pageId);
        menu.remove();
      };
      menu.appendChild(deleteBtn);
      
      // Divider
      const divider = document.createElement('div');
      divider.className = 'tag-menu-divider';
      menu.appendChild(divider);
      
      // Colors section
      const colorsLabel = document.createElement('div');
      colorsLabel.style.cssText = 'color:#9aa1aa;font-size:13px;padding:8px 12px;font-weight:600;margin-bottom:4px';
      colorsLabel.textContent = 'Colors';
      menu.appendChild(colorsLabel);
      
      const colors = [
        {name:'Default', value:'default', bg:'#e5e7eb'},
        {name:'Gray', value:'gray', bg:'#e5e7eb'},
        {name:'Brown', value:'brown', bg:'#e0d4c8'},
        {name:'Orange', value:'orange', bg:'#fed7aa'},
        {name:'Yellow', value:'yellow', bg:'#fef3c7'},
        {name:'Green', value:'green', bg:'#d1fae5'},
        {name:'Blue', value:'blue', bg:'#dbeafe'},
        {name:'Purple', value:'purple', bg:'#e9d5ff'},
        {name:'Pink', value:'pink', bg:'#fce7f3'},
        {name:'Red', value:'red', bg:'#fee2e2'}
      ];
      
      colors.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.className = 'tag-color-option';
        colorOption.innerHTML = `
          <div class="tag-color-swatch" style="background:${color.bg}"></div>
          <span>${color.name}</span>
          ${option.color === color.value ? '<span class="checkmark">✓</span>' : ''}
        `;
        colorOption.onclick = (e) => {
          e.stopPropagation();
          option.color = color.value;
          save(state);
          refreshCallback();
          renderEditor(scope, pageId);
          menu.remove();
        };
        menu.appendChild(colorOption);
      });
      
      // Position menu
      document.body.appendChild(menu);
      
      const panelRect = configPanel.getBoundingClientRect();
      const itemRect = parentItem.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();
      
      menu.style.position = 'fixed';
      menu.style.top = panelRect.top + 'px';
      menu.style.left = (panelRect.right + 8) + 'px';
      
      // Check if menu goes off screen
      if(menuRect.right > window.innerWidth){
        menu.style.left = (panelRect.left - menuRect.width - 8) + 'px';
      }
      
      // Close on outside click
      setTimeout(() => {
        const closeMenu = (e) => {
          if(!menu.contains(e.target) && !parentItem.contains(e.target)){
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        };
        document.addEventListener('click', closeMenu);
      }, 100);
      
      // Focus rename input
      renameInput.focus();
      renameInput.select();
    }

    // Open select dropdown for choosing options (PDF page 1)
    function openSelectDropdown(displayElement, property, entry, parentPage, scope, pageId, refreshCallback){
      // Remove existing dropdown
      const existingDropdown = document.querySelector('.tag-dropdown');
      if(existingDropdown) existingDropdown.remove();
      
      const dropdown = document.createElement('div');
      dropdown.className = 'tag-dropdown';
      dropdown.style.position = 'fixed';
      dropdown.style.zIndex = '10000';
      
      const displayRect = displayElement.getBoundingClientRect();
      dropdown.style.left = displayRect.left + 'px';
      dropdown.style.top = (displayRect.bottom + 4) + 'px';
      dropdown.style.minWidth = '300px';
      
      // Header
      const header = document.createElement('div');
      header.className = 'tag-dropdown-header';
      header.textContent = 'Select an option or create one';
      dropdown.appendChild(header);
      
      const currentValue = entry.properties[property.id];
      
      // Show all options
      property.options.forEach(option => {
        const item = document.createElement('div');
        item.className = 'tag-dropdown-item';
        
        let isSelected = false;
        if(property.type === 'multi_select'){
          isSelected = currentValue && currentValue.includes(option.id);
        } else {
          isSelected = currentValue === option.id;
        }
        
        if(isSelected) item.style.opacity = '0.6';
        
        item.innerHTML = `
          <span class="drag-handle">⋮⋮</span>
          <span class="tag-label tag-${option.color || 'default'}">${option.name}</span>
        `;
        
        // Click to select/deselect
        item.onclick = (e) => {
          e.stopPropagation();
          
          if(property.type === 'multi_select'){
            // Multi-select: toggle
            if(!entry.properties[property.id]){
              entry.properties[property.id] = [];
            }
            if(isSelected){
              entry.properties[property.id] = entry.properties[property.id].filter(id => id !== option.id);
            } else {
              entry.properties[property.id].push(option.id);
            }
          } else {
            // Single select: set or clear
            if(isSelected){
              entry.properties[property.id] = null;
            } else {
              entry.properties[property.id] = option.id;
            }
            dropdown.remove(); // Close after selecting for single-select
          }
          
          save(state);
          refreshCallback();
          renderEditor(scope, pageId);
          
          // For multi-select, update dropdown display
          if(property.type === 'multi_select'){
            item.style.opacity = isSelected ? '1' : '0.6';
          }
        };
        
        dropdown.appendChild(item);
      });
      
      document.body.appendChild(dropdown);
      
      // Close on outside click
      setTimeout(() => {
        const closeDropdown = (e) => {
          if(!dropdown.contains(e.target) && !displayElement.contains(e.target)){
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
          }
        };
        document.addEventListener('click', closeDropdown);
      }, 100);
    }

    // Task card context menu
    function openTaskContextMenu(e, task, column, scope, pageId){
      closeCtx(); // Close any existing context menu
      
      const menu=document.createElement('div');
      menu.className='task-ctx';
      menu.style.position='absolute'; // Use absolute positioning
      menu.style.left=e.pageX+'px'; // Use pageX for absolute positioning
      menu.style.top=e.pageY+'px'; // Use pageY for absolute positioning
      
      // Get current page
      let currentPage;
      if(scope==='workspace') currentPage = getPage(pageId);
      else if(scope==='private') currentPage = findInArray(state.privatePages, pageId);
      else if(scope==='shared') currentPage = findInArray(state.sharedPages, pageId);
      
      menu.innerHTML=`
        <div class="search-box">
          <input type="text" placeholder="Search actions..." id="taskCtxSearch"/>
        </div>
        <div class="section-title">Page</div>
        <div class="ctx-item" data-action="favorite">
          <span class="icon">☆</span>
          <span class="label">${task.favorite?'Remove from Favorites':'Add to Favorites'}</span>
        </div>
        <div class="ctx-item" data-action="icon">
          <span class="icon">😊</span>
          <span class="label">Edit icon</span>
        </div>
        <div class="ctx-item" data-action="property">
          <span class="icon">≡</span>
          <span class="label">Edit property</span>
          <span class="chevron">›</span>
        </div>
        <div class="divider"></div>
        <div class="ctx-item" data-action="layout">
          <span class="icon">📐</span>
          <span class="label">Layout</span>
        </div>
        <div class="ctx-item" data-action="visibility">
          <span class="icon">👁</span>
          <span class="label">Property visibility</span>
        </div>
        <div class="divider"></div>
        <div class="ctx-item" data-action="open">
          <span class="icon">↗</span>
          <span class="label">Open in</span>
          <span class="chevron">›</span>
        </div>
        <div class="ctx-item" data-action="comment">
          <span class="icon">💬</span>
          <span class="label">Comment</span>
          <span class="shortcut">⌘⇧M</span>
        </div>
        <div class="divider"></div>
        <div class="ctx-item" data-action="copy">
          <span class="icon">🔗</span>
          <span class="label">Copy link</span>
        </div>
        <div class="ctx-item" data-action="duplicate">
          <span class="icon">📄</span>
          <span class="label">Duplicate</span>
          <span class="shortcut">⌘D</span>
        </div>
        <div class="ctx-item" data-action="move">
          <span class="icon">→</span>
          <span class="label">Move to</span>
          <span class="shortcut">⌘⇧P</span>
        </div>
        <div class="ctx-item" data-action="delete">
          <span class="icon">🗑</span>
          <span class="label">Delete</span>
          <span class="shortcut">Del</span>
        </div>
        <div class="divider"></div>
        <div class="footer">
          Last edited by Soumikiii<br/>
          Today at ${new Date().toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', hour12:true})}
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // Position adjustment if menu goes off screen
      const rect=menu.getBoundingClientRect();
      if(rect.right>window.innerWidth){
        menu.style.left=(e.pageX-rect.width)+'px';
      }
      if(rect.bottom>window.innerHeight){
        menu.style.top=(e.pageY-rect.height)+'px';
      }
      
      // Close on click outside
      const closeMenu=()=>{
        if(menu.parentNode) menu.remove();
        document.removeEventListener('click', closeMenu);
      };
      setTimeout(()=>{
        document.addEventListener('click', closeMenu);
      }, 0);
      
      // Handle actions
      menu.querySelectorAll('.ctx-item').forEach(item=>{
        item.onclick=(ev)=>{
          ev.stopPropagation();
          const action=item.getAttribute('data-action');
          
          switch(action){
            case 'favorite':
              task.favorite=!task.favorite;
              save(state);
              renderEditor(scope, pageId);
              closeMenu();
              break;
            case 'icon':
              closeMenu();
              openIconTray(ico=>{
                task.icon=ico;
                save(state);
                renderEditor(scope, pageId);
              });
              break;
            case 'copy':
              const taskUrl = `${window.location.origin}${window.location.pathname}#task=${scope}:${pageId}:${task.id}`;
              navigator.clipboard?.writeText(taskUrl);
              closeMenu();
              // Show copied feedback
              const feedback = document.createElement('div');
              feedback.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f1f1f;color:#fff;padding:12px 20px;border-radius:8px;font-size:14px;z-index:10000';
              feedback.textContent = 'Link copied to clipboard';
              document.body.appendChild(feedback);
              setTimeout(() => feedback.remove(), 2000);
              break;
            case 'duplicate':
              const newTask={...task, id:uid('task'), title:(task.title||'Untitled')+' (copy)'};
              column.tasks.push(newTask);
              save(state);
              renderEditor(scope, pageId);
              closeMenu();
              break;
            case 'move':
              closeMenu();
              openMoveToDialog(task, column, scope, pageId);
              break;
            case 'delete':
              const idx=column.tasks.findIndex(t=>t.id===task.id);
              if(idx>-1) column.tasks.splice(idx,1);
              save(state);
              renderEditor(scope, pageId);
              closeMenu();
              break;
            case 'comment':
              closeMenu();
              alert('Comment feature (stub)');
              break;
            default:
              closeMenu();
              alert(action+' (stub)');
          }
        };
      });
      
      // Search functionality
      const searchInput=menu.querySelector('#taskCtxSearch');
      searchInput.onclick=(ev)=>ev.stopPropagation();
      searchInput.oninput=()=>{
        const query=searchInput.value.toLowerCase();
        menu.querySelectorAll('.ctx-item').forEach(item=>{
          const label=item.querySelector('.label').textContent.toLowerCase();
          item.style.display=label.includes(query)?'flex':'none';
        });
      };
    }
    
    // Move to dialog
    function openMoveToDialog(task, sourceColumn, scope, pageId){
      const dialog=document.createElement('div');
      dialog.className='task-ctx';
      dialog.style.left='50%';
      dialog.style.top='20%';
      dialog.style.transform='translateX(-50%)';
      dialog.style.maxHeight='60vh';
      dialog.style.overflow='auto';
      
      dialog.innerHTML=`
        <div class="search-box">
          <input type="text" placeholder="Move page to..." id="moveSearch"/>
        </div>
      `;
      
      const listContainer=document.createElement('div');
      
      // Suggested section
      const suggested=document.createElement('div');
      suggested.className='section';
      suggested.innerHTML='<div class="section-title">Suggested</div>';
      
      // Add Private pages option
      const privateItem=document.createElement('div');
      privateItem.className='ctx-item';
      privateItem.innerHTML='<span class="chevron">›</span><span class="icon">👤</span><span class="label">Private pages</span><span class="icon">🔒</span>';
      privateItem.onclick=()=>{
        // Move to private pages
        alert('Move to Private pages (stub)');
        dialog.remove();
      };
      suggested.appendChild(privateItem);
      
      // Add current page's children
      if(scope==='workspace'){
        const page=getPage(pageId);
        if(page){
          const pageItem=document.createElement('div');
          pageItem.className='ctx-item';
          pageItem.innerHTML=`<span class="chevron">›</span><span class="icon">${page.icon||'📄'}</span><span class="label">${page.title||'Untitled'}</span>`;
          suggested.appendChild(pageItem);
        }
      }
      
      listContainer.appendChild(suggested);
      
      // Workspace section
      const workspaceSection=document.createElement('div');
      workspaceSection.className='section';
      workspaceSection.innerHTML='<div class="section-title">Workspace</div>';
      
      Object.values(ws().pages).filter(p=>!p.parentId).forEach(p=>{
        const item=document.createElement('div');
        item.className='ctx-item';
        item.innerHTML=`<span class="chevron">›</span><span class="icon">${p.icon||'📄'}</span><span class="label">${p.title||'Untitled'}</span>`;
        item.onclick=()=>{
          // Move task to this page (stub)
          alert('Move to '+p.title+' (stub)');
          dialog.remove();
        };
        workspaceSection.appendChild(item);
      });
      
      listContainer.appendChild(workspaceSection);
      dialog.appendChild(listContainer);
      
      // Backdrop
      const backdrop=document.createElement('div');
      backdrop.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9998';
      backdrop.onclick=()=>{
        dialog.remove();
        backdrop.remove();
      };
      
      document.body.appendChild(backdrop);
      document.body.appendChild(dialog);
      
      // Search functionality
      const searchInput=dialog.querySelector('#moveSearch');
      searchInput.focus();
      searchInput.oninput=()=>{
        const query=searchInput.value.toLowerCase();
        dialog.querySelectorAll('.ctx-item').forEach(item=>{
          const label=item.querySelector('.label')?.textContent.toLowerCase()||'';
          item.style.display=label.includes(query)?'flex':'none';
        });
      };
    }

    // Page editor
    function renderEditor(scope,id){
      content.innerHTML='';
      let page = scope==='workspace' ? getPage(id)
              : scope==='private'   ? findInArray(state.privatePages,id)
              : findInArray(state.sharedPages,id);
      if(!page){ renderHome(); return; }

      document.getElementById('btnFavTop').onclick=()=>{ 
        page.favorite=!page.favorite; 
        save(state); 
        renderFavorites(); 
        // Re-render the appropriate sidebar scope
        if(scope === 'workspace') renderTree();
        else if(scope === 'private') renderPrivate();
        else if(scope === 'shared') renderShared();
        renderEditor(scope,id); 
      };
      document.getElementById('btnFavTop').textContent = page.favorite ? '★' : '☆';
      document.getElementById('btnShare').onclick=()=>alert('Share (stub)');

      // Render cover FIRST if it exists
      if(page.cover){
        const wrap=document.createElement('div'); wrap.className='cover-wrap';
        const cv=document.createElement('div'); cv.className='cover'; cv.style.backgroundImage=`url(${page.cover})`;
        const chip=document.createElement('div'); chip.className='comment-chip'; chip.innerHTML='💬 Add comment';
        chip.onclick=()=>alert('Add comment');
        
        // Icon button (only show if no icon exists)
        wrap.appendChild(chip); // Add comment chip first
        wrap.appendChild(cv); // Add cover

        // Icon button (only show if no icon exists)
        if(!page.icon){
            const iconChip=document.createElement('div'); 
            iconChip.className='comment-chip'; 
            iconChip.style.left='260px'; // Position to the right of comment chip
            iconChip.innerHTML='<img src="icons/happiness.png" class="icon" /> Add icon';
            iconChip.onclick=()=>openIconTray(ico=>{ page.icon=ico; save(state); renderTree(); renderPrivate(); renderShared(); renderFavorites(); renderEditor(scope,id); });
            wrap.appendChild(iconChip);
        } else {
            // Show the emoji if icon exists
            const emoji=document.createElement('div'); 
            emoji.className='page-emoji'; 
            emoji.textContent=page.icon;
            emoji.onclick=()=>openIconTray(ico=>{ page.icon=ico; save(state); renderTree(); renderPrivate(); renderShared(); renderFavorites(); renderEditor(scope,id); });
            wrap.appendChild(emoji);
        }

        content.appendChild(wrap);
    }

      // Quick actions bar - AFTER cover, BEFORE title
      const bar = document.createElement('div');
      bar.className = 'quick-actions';
      bar.innerHTML = `
        <div class="qa" id="qaIcon"><span class="ico"><img src="icons/happiness.png" class="icon" /></span><span>Add icon</span></div>
        <div class="qa" id="qaCover"><span class="ico"><img src="icons/image.png" class="icon" /></span><span>Add cover</span></div>
        <div class="qa" id="qaComment"><span class="ico"><img src="icons/comment.png" class="icon" style="margin-top:2px"/></span><span>Add comment</span></div>
      `;
      content.appendChild(bar);

      const qaIcon = bar.querySelector('#qaIcon');
      const qaCover = bar.querySelector('#qaCover');
      const qaComment = bar.querySelector('#qaComment');

      qaIcon.onclick = () => openIconTray(ico=>{
        page.icon = ico; save(state);
        renderTree(); renderPrivate(); renderShared(); renderFavorites(); renderEditor(scope,id);
      });

      qaCover.onclick = () => {
        fileCover.value=''; fileCover.click();
        fileCover.onchange = (e)=>{
          const f = e.target.files?.[0]; if(!f) return;
          const r=new FileReader();
          r.onload = ()=>{ page.cover = r.result; save(state); renderEditor(scope,id); };
          r.readAsDataURL(f);
        };
      };

      qaComment.onclick = () => alert('Add comment (stub)');

      // Hide/show buttons based on state
      const isTaskList = (page.title||'').toLowerCase()==='task list';
        if(isTaskList){
        // For task list: only show "Add cover" and hide icon/comment
        qaIcon.style.display='none';
        qaComment.innerHTML='<img src="icons/information.png" style="width:18px;height:18px;vertical-align:middle;margin-right:6px">Hide description';
        // qaComment.textContent='Hide description';
        if(page.cover) qaCover.style.display='none';
        } else {
        // For regular pages
        if(page.icon){ 
            qaIcon.style.display='none'; 
        }
        if(page.cover){ 
            qaCover.style.display='none'; 
        }
        }

      const titleInput=document.createElement('input');
      titleInput.className='input';
      titleInput.style.cssText='font-size:32px;font-weight:800;border:none;outline:none;background:transparent;padding:0;margin:12px 0 6px 0;width:100%';
      titleInput.value=page.title||'';
      titleInput.oninput=()=>{ page.title=titleInput.value; save(state); renderTree(); renderPrivate(); renderShared(); renderFavorites(); renderCrumbs(); };

      const titleRow=document.createElement('div'); titleRow.className='title-row';
      const titleIcon=document.createElement('span'); titleIcon.className='title-emoji';
      
      // For Task List, always show checkmark icon and don't allow changes
      // const isTaskList = (page.title||'').toLowerCase()==='task list';
      if(isTaskList){
        titleIcon.textContent = '✓';
        titleIcon.style.cursor = 'default';
        titleIcon.onclick = null;
      } else {
        titleIcon.textContent = page.cover ? '' : (page.icon || '');
        titleIcon.onclick=()=>openIconTray(ico=>{ page.icon=ico; save(state); renderTree(); renderPrivate(); renderShared(); renderFavorites(); renderEditor(scope,id); });
      }
      
      titleRow.appendChild(titleIcon);
      titleRow.appendChild(titleInput);
      content.appendChild(titleRow);

      // FIX #3: Render nested pages with new style
      if(scope==='workspace' && page.children?.length){
        const list=document.createElement('div'); 
        list.style.cssText='margin:16px 0; display:flex; flex-direction:column; gap:4px;';
        
        page.children.forEach(cid=>{
          const child=getPage(cid); if(!child) return;
          
          const link = document.createElement('div');
          link.className = 'page-link';
          link.draggable = false;
          
          // Plus icon (shows on hover)
          const plusIcon = document.createElement('span');
          plusIcon.className = 'page-link-icon';
          plusIcon.textContent = '＋';
          plusIcon.style.fontSize = '14px';
          plusIcon.setAttribute('data-tooltip', 'Click to add below');
          
          // Drag handle (shows on hover)
          const dragIcon = document.createElement('span');
          dragIcon.className = 'page-link-icon page-link-drag';
          dragIcon.textContent = '⋮⋮';
          dragIcon.setAttribute('data-tooltip', 'Drag to move');

          dragIcon.onmousedown = () => {
            link.draggable = true;
          };
          dragIcon.onmouseup = () => {
            link.draggable = false;
          };
          
          // Page text with icon
          const textSpan = document.createElement('span');
          textSpan.className = 'page-link-text';
          textSpan.innerHTML = `<span class="doc-icon">${child.icon || '📄'}</span>${child.title || 'Untitled'}`;
          
          link.appendChild(plusIcon);
          link.appendChild(dragIcon);
          link.appendChild(textSpan);

          // Drag & drop for reordering
          link.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', JSON.stringify({id:child.id, scope:'workspace', parentId:page.id, type:'nested'}));
          });
          link.addEventListener('dragover', e => { 
            e.preventDefault(); 
            link.style.borderTop = '2px solid #1d9bf0';
          });
          link.addEventListener('dragleave', () => { 
            link.style.borderTop = '';
          });
          link.addEventListener('drop', e => {
            e.preventDefault(); 
            link.style.borderTop = '';
            const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
            if(!data.id || data.type !== 'nested' || data.id === child.id || data.parentId !== page.id) return;
            
            // Reorder within the same parent
            const fromIndex = page.children.indexOf(data.id);
            const toIndex = page.children.indexOf(child.id);
            if(fromIndex < 0 || toIndex < 0) return;
            
            page.children.splice(fromIndex, 1);
            page.children.splice(toIndex, 0, data.id);
            save(state); 
            renderTree(); 
            renderEditor(scope, id);
          });
          
          // Click to navigate
          link.onclick = (e) => {
            if(e.target === plusIcon) {
              e.stopPropagation();
              // Add child to this nested page
              const newId = uid('pg');
              ws().pages[newId] = {id:newId, title:'Untitled', parentId:child.id, children:[], favorite:false, blocks:[], icon:'', cover:'', body:''};
              child.children.push(newId);
              save(state); renderTree(); renderEditor(scope, id);
              return;
            }
            clearTimeout(hoverTimeout);
            hidePagePreview();
            openEditor('workspace', child.id);
          };
          
          // Hover to show preview
          let hoverTimeout;
          const showPreviewHandler = (e) => {
            // Only show preview when hovering over text or doc icon, not control icons
            if(e.target === plusIcon || e.target === dragIcon) return;
            hoverTimeout = setTimeout(() => {
              showPagePreview(link, child, scope);
            }, 500);
          };
          
          textSpan.onmouseenter = showPreviewHandler;
          textSpan.onmouseleave = () => {
            clearTimeout(hoverTimeout);
            hidePagePreview();
          };
          
          list.appendChild(link);
        });
        content.appendChild(list);
      } else if((scope==='private' || scope==='shared') && page.children?.length){
        const list=document.createElement('div'); 
        list.style.cssText='margin:16px 0; display:flex; flex-direction: column; gap:4px;';
        
        page.children.forEach(childObj=>{
          const link = document.createElement('div');
          link.className = 'page-link';
          link.draggable = false;
          
          const plusIcon = document.createElement('span');
          plusIcon.className = 'page-link-icon';
          plusIcon.textContent = '＋';
          plusIcon.style.fontSize = '14px';
          plusIcon.setAttribute('data-tooltip', 'Click to add below');
          
          const dragIcon = document.createElement('span');
          dragIcon.className = 'page-link-icon page-link-drag';
          dragIcon.textContent = '⋮⋮';
          dragIcon.setAttribute('data-tooltip', 'Drag to move');

          dragIcon.onmousedown = () => {
            link.draggable = true;
          };
          dragIcon.onmouseup = () => {
            link.draggable = false;
          };
          
          const textSpan = document.createElement('span');
          textSpan.className = 'page-link-text';
          textSpan.innerHTML = `<span class="doc-icon">${childObj.icon || '📄'}</span>${childObj.title || 'Untitled'}`;
          
          link.appendChild(plusIcon);
          link.appendChild(dragIcon);
          link.appendChild(textSpan);

          // Drag & drop for reordering
          link.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', JSON.stringify({id:childObj.id, scope:scope, parentId:page.id, type:'nested'}));
          });
          link.addEventListener('dragover', e => { 
            e.preventDefault(); 
            link.style.borderTop = '2px solid #1d9bf0';
          });
          link.addEventListener('dragleave', () => { 
            link.style.borderTop = '';
          });
          link.addEventListener('drop', e => {
            e.preventDefault(); 
            link.style.borderTop = '';
            const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
            if(!data.id || data.type !== 'nested' || data.id === childObj.id || data.parentId !== page.id) return;
            
            // Reorder within the same parent
            const fromIndex = page.children.findIndex(c => c.id === data.id);
            const toIndex = page.children.findIndex(c => c.id === childObj.id);
            if(fromIndex < 0 || toIndex < 0) return;
            
            const [movedItem] = page.children.splice(fromIndex, 1);
            page.children.splice(toIndex, 0, movedItem);
            save(state); 
            if(scope==='private') renderPrivate();
            else renderShared();
            renderEditor(scope, id);
          });
          
          link.onclick = (e) => {
            if(e.target === plusIcon) {
              e.stopPropagation();
              const newPage = {id:uid(scope==='private'?'priv':'shr'), title:'Untitled', children:[], icon:'', cover:'', body:'', favorite:false};
              childObj.children.push(newPage);
              save(state); 
              if(scope==='private') renderPrivate();
              else renderShared();
              renderEditor(scope, id);
              return;
            }
            clearTimeout(hoverTimeout);
            hidePagePreview();
            openEditor(scope, childObj.id);
          };
          
          // Hover to show preview - only on text/icon area
          let hoverTimeout;
          const showPreviewHandler = (e) => {
            // Only show preview when hovering over text or doc icon, not control icons
            if(e.target === plusIcon || e.target === dragIcon) return;
            hoverTimeout = setTimeout(() => {
              showPagePreview(link, childObj, scope);
            }, 500);
          };
          
          textSpan.onmouseenter = showPreviewHandler;
          textSpan.onmouseleave = () => {
            clearTimeout(hoverTimeout);
            hidePagePreview();
          };
          
          list.appendChild(link);
        });
        content.appendChild(list);
      }

      if((page.title||'').toLowerCase()==='task list'){
        // Initialize board structure if it doesn't exist or is in old format
        if(!page.board || !page.board.columns){
          page.board={
            columns:[
              {id:'todo', label:'To Do', color:'red', tasks: page.board?.todo || []},
              {id:'doing', label:'Doing', color:'amber', tasks: page.board?.doing || []},
              {id:'done', label:'Done 🙌', color:'green', tasks: page.board?.done || []}
            ]
          };
          save(state);
        }
        
        // Task description
        const desc=document.createElement('div');
        desc.className='task-description';
        desc.innerHTML=`Use this template to track your personal tasks.<br/>Click <span style="color:#ef4444;font-weight:600">+ New</span> to create a new task directly on this board.<br/>Click an existing task to add additional context or subtasks.`;
        content.appendChild(desc);
        
        // Board view button
        const boardViewBtn=document.createElement('div');
        boardViewBtn.className='board-view-btn';
        boardViewBtn.innerHTML='<span style="font-size:18px"><img src="icons/database.png" class="icon"></span> Board View';
        content.appendChild(boardViewBtn);
        
        // Board header with controls
        const boardHeader=document.createElement('div');
        boardHeader.className='task-board-header';
        boardHeader.innerHTML=`
          <div></div>
          <div class="task-board-controls">
            <button class="control-btn" data-label="Filter"><img src="icons/filter.png" class="icon"></button>
            <button class="control-btn" data-label="Sort"><img src="icons/sort.png" class="icon"></button>
            <button class="control-btn" data-label="Properties"><img src="icons/flash.png" class="icon"></button>
            <button class="control-btn" data-label="Search"><img src="icons/search.png" class="icon"></button>
            <button class="control-btn" data-label="Settings"><img src="icons/setting.png" class="icon"></button>
            <button class="control-btn new-btn">New <img src="icons/down-chevron.png" class="icon" style="margin-left: 3px"></button>
          </div>
        `;
        content.appendChild(boardHeader);
        
        // Board
        const board=document.createElement('div'); 
        board.className='board';
        
        // Render columns
        page.board.columns.forEach((column,colIndex)=>{
          const col=document.createElement('div'); 
          col.className='col '+column.color;
          
          // Column header
          const head=document.createElement('div'); 
          head.className='head';
          head.innerHTML=`
            <span>${column.label}</span>
            <span class="count">${column.tasks.length}</span>
            <div class="controls">
              <button title="More">⋯</button>
              <button title="Add">＋</button>
            </div>
          `;
          col.appendChild(head);
          
          // Column body
          const body=document.createElement('div'); 
          body.className='body';
          
          // Render tasks
          column.tasks.forEach((task,taskIndex)=>{
            const taskCard=document.createElement('div');
            taskCard.className='task-card';
            
            taskCard.draggable=false;
            
            // Drag and drop handlers
            let isDragging=false;
            
            taskCard.addEventListener('dragstart', e=>{
              isDragging=true;
              e.dataTransfer.setData('text/plain', JSON.stringify({
                taskId:task.id,
                sourceColumnId:column.id,
                type:'task'
              }));
              taskCard.style.opacity='0.5';
            });
            
            taskCard.addEventListener('dragend', ()=>{
              isDragging=false;
              taskCard.style.opacity='1';
            });
            
            taskCard.addEventListener('dragover', e=>{
              if(isDragging) return;
              e.preventDefault();
              taskCard.style.borderTop='2px solid #3b82f6';
            });
            
            taskCard.addEventListener('dragleave', ()=>{
              taskCard.style.borderTop='';
            });
            
            taskCard.addEventListener('drop', e=>{
              e.preventDefault();
              taskCard.style.borderTop='';
              
              const data=JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
              if(!data.taskId || data.type!=='task') return;
              
              // Find source column
              let sourceColumn=page.board.columns.find(c=>c.id===data.sourceColumnId);
              if(!sourceColumn) return;
              
              // Find and remove task from source
              const sourceIndex=sourceColumn.tasks.findIndex(t=>t.id===data.taskId);
              if(sourceIndex<0) return;
              const [movedTask]=sourceColumn.tasks.splice(sourceIndex,1);
              
              // If moving to different column, update status
              if(sourceColumn.id!==column.id){
                movedTask.status=column.id;
              }
              
              // Insert at target position
              const targetIndex=column.tasks.findIndex(t=>t.id===task.id);
              column.tasks.splice(targetIndex,0,movedTask);
              
              save(state);
              renderEditor(scope,id);
            });
            // Content wrapper
            const cardContent=document.createElement('div');
            cardContent.className='task-card-content';
            
            const taskInput=document.createElement('input');
            taskInput.value=task.title||'';
            taskInput.placeholder='Type a name...';
            
            let isEditing = false;
            
            taskInput.onfocus=()=>{
              isEditing = true;
            };
            
            taskInput.onblur=()=>{
              setTimeout(()=>{
                isEditing = false;
              }, 100);
            };
            
            taskInput.onchange=()=>{
              task.title=taskInput.value;
              save(state);
            };
            
            taskInput.onclick=(e)=>{
              e.stopPropagation();
            };
            
            cardContent.appendChild(taskInput);
            
            // Show preview of task body if it exists
            if(task.body && task.body.trim()){
              const preview=document.createElement('div');
              preview.style.cssText='margin-top:6px;color:#6b7280;font-size:13px;line-height:1.4;max-height:60px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;';
              preview.textContent=task.body;
              cardContent.appendChild(preview);
            }
            
            // Controls (Edit and More)
            const controls=document.createElement('div');
            controls.className='task-card-controls';
            
            // Drag handle
            const dragHandle=document.createElement('button');
            dragHandle.innerHTML='⋮⋮';
            dragHandle.title='Drag';
            dragHandle.style.cursor='grab';
            dragHandle.onmousedown=()=>{
              taskCard.draggable=true;
            };
            dragHandle.onmouseup=()=>{
              taskCard.draggable=false;
            };

            const editBtn=document.createElement('button');
            editBtn.innerHTML='✏️';
            editBtn.title='Edit';
            editBtn.onclick=(e)=>{
              e.stopPropagation();
              taskInput.focus();
            };
            
            const moreBtn=document.createElement('button');
            moreBtn.innerHTML='⋯';
            moreBtn.title='More';
            moreBtn.onclick=(e)=>{
              e.stopPropagation();
              openTaskContextMenu(e, task, column, scope, id);
            };
            
            controls.appendChild(dragHandle);
            controls.appendChild(editBtn);
            controls.appendChild(moreBtn);
            
            taskCard.appendChild(cardContent);
            taskCard.appendChild(controls);
            
            taskCard.onclick=(e)=>{
              // Only open detail if not currently editing the input
              if(!isEditing && e.target !== taskInput && !e.target.closest('.task-card-controls')){
                openTaskDetail(task, column, scope, id);
              }
            };
            
            body.appendChild(taskCard);
          });
          
          // Add new task button
          const addBtn=document.createElement('div'); 
          addBtn.className='new';
          addBtn.innerHTML='<span>＋</span> New page';
          addBtn.onclick=()=>{ 
            const newTask={
              id:uid('task'),
              title:'',
              body:'',
              status:column.id,
              createdAt:new Date().toISOString(),
              properties:{}
            };
            column.tasks.push(newTask); 
            save(state); 
            renderEditor(scope,id);
          };
          body.appendChild(addBtn);
          
          col.appendChild(body);
          board.appendChild(col);
        });
        
        // Add "New group" column
        const newGroupCol=document.createElement('div');
        newGroupCol.className='new-group-col';
        newGroupCol.innerHTML='＋ New group';
        newGroupCol.onclick=()=>{
          const groupName=prompt('Enter group name:');
          if(!groupName) return;
          page.board.columns.push({
            id:uid('col'),
            label:groupName,
            color:'red',
            tasks:[]
          });
          save(state);
          renderEditor(scope,id);
        };
        board.appendChild(newGroupCol);
        
        content.appendChild(board);
      }

      // Database/List view rendering
      if(page.viewType === 'database'){
        // Remove get-started options
        const getStarted = document.querySelector('.get-started-section');
        if(getStarted) getStarted.remove();
        
        // Initialize database structure if needed
        if(!page.database){
          page.database = {
            entries: [],
            tagOptions: [], // For the Tags property specifically
            properties: [], // Custom properties for this database
            sort: {field: null, direction: 'asc'}
          };
        }
        
        // Ensure tagOptions exists (for backward compatibility)
        if(!page.database.tagOptions){
          page.database.tagOptions = [];
        }
        
        // Ensure properties array exists
        if(!page.database.properties){
          page.database.properties = [];
        }
        
        // Render list view
        const listContainer = document.createElement('div');
        listContainer.className = 'list-view-container';
        
        // Header with view selector and controls
        const header = document.createElement('div');
        header.className = 'list-view-header';
        header.style.flexDirection = 'column';
        header.style.alignItems = 'flex-start';
        
        // Check if there's an active sort
        const hasActiveSort = page.database.sort && page.database.sort.field;
        
        // Top row with List view button and control buttons
        const topRow = document.createElement('div');
        topRow.style.cssText = 'display:flex;align-items:center;width:100%;margin-bottom:12px';
        topRow.innerHTML = `
          <button class="list-view-btn">
            <span class="icon"><img src="icons/list.png" class="icon"></span>
            <span>List view</span>
          </button>
          <div class="list-view-controls" style="margin-left:auto">
            <button class="control-btn" data-label="Filter" style="border: 0px"><img src="icons/filter.png" class="icon"/></button>
            <button class="control-btn ${hasActiveSort ? 'sort-active' : ''}" data-label="Sort" id="btnSort" style="border: 0px"><img src="icons/sort.png" class="icon"></button>
            <button class="control-btn" data-label="Search" style="border: 0px"><img src="icons/search.png" class="icon"></button>
            <button class="control-btn" data-label="Settings" style="border: 0px"><img src="icons/setting.png" class="icon"></button>
            <button class="control-btn new-btn" id="dbNewEntry">New <img src="icons/down-chevron.png" class="icon" style="margin-left: 3px"></button>
          </div>
        `;
        header.appendChild(topRow);
        
        // Separator line
        const separator = document.createElement('div');
        separator.className = 'list-view-separator';
        header.appendChild(separator);
        
        // Bottom row with Filter and Sort chips
        const bottomRow = document.createElement('div');
        bottomRow.style.cssText = 'display:flex;align-items:center;gap:8px;width:100%';
        
        // Filter chip (always visible)
        const filterChip = document.createElement('button');
        filterChip.className = 'filter-chip';
        filterChip.innerHTML = '<span class="icon">＋</span><span>Filter</span>';
        filterChip.onclick = (e) => {
          e.stopPropagation();
          openFilterDropdown(filterChip, page, scope, id);
        };
        bottomRow.appendChild(filterChip);
        
        // Sort chip (only if sort is active)
        if(hasActiveSort){
          const sortFieldLabels = {
            'name': 'Name',
            'created': 'Created',
            'tags': 'Tags'
          };
          const sortLabel = sortFieldLabels[page.database.sort.field] || page.database.sort.field;
          const sortDirection = page.database.sort.direction === 'asc' ? '↑' : '↓';
          
          const sortChip = document.createElement('button');
          sortChip.className = 'sort-chip';
          sortChip.innerHTML = `
            <span class="arrow">${sortDirection}</span>
            <span>${sortLabel}</span>
            <span class="close">×</span>
          `;
          
          // Click chip to open sort management dropdown
          sortChip.onclick = (e) => {
            if(e.target.classList.contains('close')){
              // Clear sort
              page.database.sort = {field: null, direction: 'asc'};
              save(state);
              renderEditor(scope, id);
            } else {
              e.stopPropagation();
              openSortManageDropdown(sortChip, page, scope, id);
            }
          };
          
          bottomRow.appendChild(sortChip);
        }
        
        header.appendChild(bottomRow);
        listContainer.appendChild(header);
        
        // Entries list
        const entriesList = document.createElement('div');
        entriesList.className = 'list-entries';
        
        // Render existing entries
        page.database.entries.forEach((entry, index) => {
          const entryEl = document.createElement('div');
          entryEl.className = 'list-entry';
          
          const icon = document.createElement('span');
          icon.className = 'icon';
          icon.textContent = entry.icon || '📄';
          
          const titleDiv = document.createElement('div');
          titleDiv.className = 'title';
          
          const titleInput = document.createElement('input');
          titleInput.value = entry.name || 'New page';
          titleInput.placeholder = 'New page';
          
          let isEditing = false;
          titleInput.onfocus = () => { isEditing = true; };
          titleInput.onblur = () => { 
            setTimeout(() => { isEditing = false; }, 100); 
          };
          titleInput.onchange = () => {
            entry.name = titleInput.value;
            save(state);
          };
          titleInput.onclick = (e) => { e.stopPropagation(); };
          
          titleDiv.appendChild(titleInput);
          
          entryEl.appendChild(icon);
          entryEl.appendChild(titleDiv);
          
          // Add tags display
          const tagsContainer = document.createElement('div');
          tagsContainer.style.cssText = 'display:flex;gap:6px;align-items:center;margin-left:auto;flex-wrap:wrap';
          
          if(entry.properties.tags && entry.properties.tags.length > 0){
            entry.properties.tags.forEach(tagId => {
              const tagOption = page.database.tagOptions.find(t => t.id === tagId);
              if(tagOption){
                const tagPill = document.createElement('span');
                tagPill.className = `tag-pill tag-${tagOption.color || 'default'}`;
                tagPill.textContent = tagOption.name;
                tagPill.style.cursor = 'pointer';
                tagPill.onclick = (e) => {
                  e.stopPropagation();
                  openDatabaseEntry(entry, page, scope, id);
                };
                tagsContainer.appendChild(tagPill);
              }
            });
          }
          
          entryEl.appendChild(tagsContainer);
          
          // Click to open entry detail
          entryEl.onclick = (e) => {
            if(!isEditing && e.target !== titleInput){
              openDatabaseEntry(entry, page, scope, id);
            }
          };
          
          entriesList.appendChild(entryEl);
        });
        
        // Add new entry button
        const newEntryBtn = document.createElement('div');
        newEntryBtn.className = 'new-entry-btn';
        newEntryBtn.innerHTML = '<span>＋</span> New page';
        newEntryBtn.onclick = () => {
          const newEntry = {
            id: uid('entry'),
            name: '',
            icon: '📄',
            created: new Date().toISOString(),
            properties: {},
            body: ''
          };
          page.database.entries.push(newEntry);
          save(state);
          renderEditor(scope, id);
          setTimeout(() => {
            openDatabaseEntry(newEntry, page, scope, id);
          }, 100);
        };
        entriesList.appendChild(newEntryBtn);
        
        listContainer.appendChild(entriesList);
        content.appendChild(listContainer);
        
        // New button handler
        header.querySelector('#dbNewEntry').onclick = () => {
          const newEntry = {
            id: uid('entry'),
            name: '',
            icon: '📄',
            created: new Date().toISOString(),
            properties: {}
          };
          page.database.entries.push(newEntry);
          save(state);
          renderEditor(scope, id);
          setTimeout(() => {
            openDatabaseEntry(newEntry, page, scope, id);
          }, 100);
        };

        // Sort button handler
        header.querySelector('#btnSort').onclick = (e) => {
          e.stopPropagation();
          openSortDropdown(e.currentTarget, page, scope, id);
        };
        
        return; // Don't render the text area
      }

      const ta=document.createElement('div');
      ta.contentEditable = 'true';
      ta.style.cssText='min-height:220px; outline:none; padding-top:8px';
      ta.dataset.placeholder = "Write, press 'space' for AI, '/' for commands…";
      ta.className='editor-placeholder';
      ta.onfocus=()=>{ if(!page.body){ ta.textContent=''; ta.classList.remove('editor-placeholder'); } };
      ta.onblur =()=>{ if(!ta.textContent.trim()){ ta.textContent=ta.dataset.placeholder; ta.classList.add('editor-placeholder'); } };
      if(page.body){ ta.textContent=page.body; ta.classList.remove('editor-placeholder'); } else { ta.textContent=ta.dataset.placeholder; }
      ta.oninput=()=>{ if(ta.classList.contains('editor-placeholder')) return; page.body=ta.textContent; save(state); };
      content.appendChild(ta);
      
      // Show "Get started with" options for empty pages (no body content and no special type)
      // const isTaskList = (page.title||'').toLowerCase()==='task list';
      const isEmpty = !page.body || page.body.trim() === '';
      
      if(isEmpty && !isTaskList && !page.viewType){
        showGetStartedOptions(page, scope, id);
      
    }}

    // Show "Get started with" options for new pages
    // Show "Get started with" options for new pages
    function showGetStartedOptions(page, scope, pageId){
      // Remove existing if any
      const existing = document.querySelector('.get-started-section');
      if(existing) existing.remove();
      
      const section = document.createElement('div');
      section.className = 'get-started-section';
      
      const label = document.createElement('div');
      label.className = 'get-started-label';
      label.textContent = 'Get started with';
      
      const buttons = document.createElement('div');
      buttons.className = 'get-started-buttons';
      buttons.innerHTML = `
        <button class="get-started-btn" id="btnDatabase">
          <span class="icon"><img src="icons/database.png" class="icon" style="margin-bottom:2.5px"/></span>
          <span>Database</span>
        </button>
        <button class="get-started-btn" id="btnForm">
          <span class="icon"><img src="icons/form.png" class="icon" style="margin-bottom:2.5px"/></span>
          <span>Form</span>
        </button>
        <button class="get-started-btn" id="btnTemplates">
          <span class="icon"><img src="icons/templates.png" class="icon" style="margin-bottom:2.5px"/></span>
          <span>Templates</span>
        </button>
        <button class="get-started-btn more-btn" id="btnMoreViews">
          <span class="icon"><img src="icons/dots.png" class="icon" style="margin-bottom:2.5px"/></span>
        </button>
      `;
      
      section.appendChild(label);
      section.appendChild(buttons);
      
      // Append to content area instead of body
      content.appendChild(section);
      
      // Database button
      buttons.querySelector('#btnDatabase').onclick = () => {
        page.viewType = 'database';
        page.viewLayout = 'table'; // Default to table view
        if(!page.database){
          page.database = {
            entries: [],
            properties: [
              {id:'name', name:'Name', type:'title'},
              {id:'tags', name:'Tags', type:'multi_select', options:[]},
              {id:'created', name:'Created', type:'created_time'}
            ]
          };
        }
        save(state);
        renderEditor(scope, pageId);
      };
      
      // Form button
      buttons.querySelector('#btnForm').onclick = () => {
        alert('Form view (coming soon)');
      };
      
      // Templates button
      buttons.querySelector('#btnTemplates').onclick = () => {
        alert('Templates (coming soon)');
      };
      
      // More views button (...)
      buttons.querySelector('#btnMoreViews').onclick = (e) => {
        openViewTypeSelector(e, page, scope, pageId);
      };
    }
    
    // Open view type selector overlay
    function openViewTypeSelector(e, page, scope, pageId){
      // Remove existing overlay
      const existingOverlay = document.querySelector('.view-type-overlay');
      if(existingOverlay) existingOverlay.remove();
      const existingBackdrop = document.querySelector('.view-type-backdrop');
      if(existingBackdrop) existingBackdrop.remove();
      
      const backdrop = document.createElement('div');
      backdrop.className = 'view-type-backdrop';
      
      const overlay = document.createElement('div');
      overlay.className = 'view-type-overlay';
      
      const viewTypes = [
        {icon:'▦', label:'Table', type:'table'},
        {icon:'▦', label:'Board', type:'board'},
        {icon:'☰', label:'List', type:'list'},
        {icon:'📄', label:'Timeline', type:'timeline'},
        {icon:'📅', label:'Calendar', type:'calendar'},
        {icon:'▦', label:'Gallery', type:'gallery'}
      ];
      
      viewTypes.forEach(view => {
        const option = document.createElement('div');
        option.className = 'view-option';
        option.innerHTML = `
          <span class="icon">${view.icon}</span>
          <span class="label">${view.label}</span>
        `;
        option.onclick = () => {
          page.viewType = 'database';
          page.viewLayout = view.type;
          page.title = 'New database';
          if(!page.database){
            page.database = {
              entries: [],
              properties: [
                {id:'name', name:'Name', type:'title'},
                {id:'tags', name:'Tags', type:'multi_select', options:[]},
                {id:'created', name:'Created', type:'created_time'}
              ]
            };
          }
          save(state);
          closeViewSelector();
          renderEditor(scope, pageId);
        };
        overlay.appendChild(option);
      });
      
      // Divider
      const divider = document.createElement('div');
      divider.className = 'divider';
      overlay.appendChild(divider);
      
      // Import option
      const importOption = document.createElement('div');
      importOption.className = 'view-option';
      importOption.innerHTML = `
        <span class="icon">↓</span>
        <span class="label">Import</span>
      `;
      importOption.onclick = () => {
        closeViewSelector();
        alert('Import (coming soon)');
      };
      overlay.appendChild(importOption);
      
      // Position the overlay below the "..." button
      const btnRect = e.currentTarget.getBoundingClientRect();
      
      overlay.style.left = (btnRect.left - 20) + 'px';
      overlay.style.bottom = (window.innerHeight - btnRect.top + 12) + 'px';
      overlay.style.top = 'auto';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(overlay);
      
      // Close on backdrop click
      const closeViewSelector = () => {
        if(backdrop.parentNode) backdrop.remove();
        if(overlay.parentNode) overlay.remove();
      };
      
      backdrop.onclick = closeViewSelector;
    }

    function render(){
      renderFavorites();
      renderTree();
      renderPrivate();
      renderShared();
      renderCrumbs();
      initSectionToggles(); // Initialize section toggles
      if(state.viewScope==='home') renderHome();
      else renderEditor(state.viewScope,state.viewId);
    }

    document.getElementById('btnCollapse').onclick=()=>document.body.classList.add('collapsed');
    document.getElementById('btnOpenSidebar').onclick=()=>document.body.classList.remove('collapsed');
    document.getElementById('btnNewNote').onclick=()=>{ const id=uid('pg'); ws().pages[id]={id,title:'Untitled',parentId:null,children:[],favorite:false,blocks:[],icon:'',cover:'',body:''}; ws().rootOrder.push(id); save(state); renderTree(); openEditor('workspace', id); };
    document.getElementById('btnChevron').onclick=()=>alert('Account menu (stub)');

    render();
  </script>
</body>
</html>
